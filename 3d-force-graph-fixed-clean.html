<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Competitive Monitor - 3D Force Graph (Fixed)</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #eee;
            overflow: hidden;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(20, 20, 30, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            max-width: 350px;
            z-index: 100;
            backdrop-filter: blur(10px);
            pointer-events: none;
        }
        
        #info h3 {
            margin: 0 0 10px 0;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(20, 20, 30, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            z-index: 100;
            width: 280px;
            backdrop-filter: blur(10px);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .control-group {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 12px;
        }
    </style>
    <script src="https://unpkg.com/three@0.152.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three-spritetext@1.8.0/dist/three-spritetext.min.js"></script>
    <script src="https://unpkg.com/3d-force-graph@1.73.0/dist/3d-force-graph.min.js"></script>
</head>
<body>
    <div id="info">
        <h3>ðŸ§  AI Competitive Monitor</h3>
        <div id="node-info">Left-click and drag to rotate â€¢ Scroll to zoom</div>
    </div>
    
    <div id="controls">
        <h4>Controls</h4>
        <div class="control-group">
            <label>
                Show Links
                <input type="checkbox" id="toggle-links" checked>
            </label>
            <label>
                Show Labels
                <input type="checkbox" id="toggle-labels" checked>
            </label>
        </div>
    </div>
    
    <div id="3d-graph"></div>

    <script>
        console.log('Initializing AI Competitive Monitor 3D Force Graph...');
        
        let Graph;
        let graphData = { nodes: [], links: [] };
        let rawData = null;
        
        // Configuration
        const CONFIG = {
            linkDistance: 30,
            linkWidth: 0.3,
            forceStrength: -300,
            nodeColors: {
                'Company': '#6fbf6f',
                'AI Company': '#00ff88',
                'AI Tool': '#ff6f00',
                'AI Model Provider': '#ff00ff',
                'AI Concept': '#00ffff',
                'default': '#888888'
            }
        };
        
        // Simple node creation function
        function createSimpleNode(company) {
            return {
                id: company.company,
                name: company.company,
                group: company.type || 'Company',
                val: company.url_count || 1
            };
        }
        
        // Load and process data
        async function loadData() {
            try {
                console.log('Loading data...');
                const response = await fetch('https://redmorestudio.github.io/ai-competitive-monitor/api-data');
                rawData = await response.json();
                
                if (!rawData.dashboard?.company_activity) {
                    throw new Error('Invalid data structure');
                }
                
                console.log('Data loaded successfully');
                buildGraph();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('node-info').textContent = 'Error loading data: ' + error.message;
            }
        }
        
        function buildGraph() {
            console.log('Building graph...');
            
            // Clear existing data
            graphData.nodes = [];
            graphData.links = [];
            
            // Create nodes
            const nodeMap = new Map();
            rawData.dashboard.company_activity.forEach(company => {
                const node = createSimpleNode(company);
                graphData.nodes.push(node);
                nodeMap.set(company.company, node);
            });
            
            console.log(`Created ${graphData.nodes.length} nodes`);
            
            // Create links based on shared technologies
            const techMap = new Map();
            rawData.dashboard.company_activity.forEach(company => {
                if (company.intelligence?.ai_technologies) {
                    company.intelligence.ai_technologies.forEach(tech => {
                        if (!techMap.has(tech)) {
                            techMap.set(tech, []);
                        }
                        techMap.get(tech).push(company.company);
                    });
                }
            });
            
            // Connect companies that share technologies
            techMap.forEach((companies, tech) => {
                if (companies.length > 1) {
                    for (let i = 0; i < companies.length - 1; i++) {
                        for (let j = i + 1; j < companies.length; j++) {
                            // Create simple link object
                            const link = {
                                source: companies[i],
                                target: companies[j]
                            };
                            graphData.links.push(link);
                        }
                    }
                }
            });
            
            console.log(`Created ${graphData.links.length} links`);
            
            // Initialize the graph
            initializeGraph();
        }
        
        function initializeGraph() {
            console.log('Initializing 3D graph...');
            
            try {
                // Create graph instance
                Graph = ForceGraph3D()(document.getElementById('3d-graph'));
                
                // Set data first with clean objects
                const cleanData = {
                    nodes: graphData.nodes.map(n => ({
                        id: n.id,
                        name: n.name,
                        group: n.group,
                        val: n.val
                    })),
                    links: graphData.links.map(l => ({
                        source: l.source,
                        target: l.target
                    }))
                };
                
                console.log('Setting graph data:', cleanData);
                Graph.graphData(cleanData);
                
                // Configure appearance
                Graph
                    .nodeLabel('name')
                    .nodeAutoColorBy('group')
                    .nodeVal('val')
                    .linkWidth(CONFIG.linkWidth)
                    .linkOpacity(0.2)
                    .onNodeHover(node => {
                        document.getElementById('node-info').textContent = node ? 
                            `${node.name} (${node.group})` : 
                            'Left-click and drag to rotate â€¢ Scroll to zoom';
                    });
                
                // Set forces
                Graph.d3Force('charge').strength(CONFIG.forceStrength);
                Graph.d3Force('link').distance(CONFIG.linkDistance);
                
                console.log('Graph initialized successfully!');
                
            } catch (error) {
                console.error('Error initializing graph:', error);
                console.error('Stack:', error.stack);
                document.getElementById('node-info').textContent = 'Error: ' + error.message;
            }
        }
        
        // Event handlers
        document.getElementById('toggle-links').addEventListener('change', (e) => {
            if (Graph) {
                Graph.linkOpacity(e.target.checked ? 0.2 : 0);
            }
        });
        
        document.getElementById('toggle-labels').addEventListener('change', (e) => {
            if (Graph) {
                Graph.nodeLabel(e.target.checked ? 'name' : '');
            }
        });
        
        // Start loading
        loadData();
    </script>
</body>
</html>