<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Competitive Monitor - Enhanced Dashboard</title>
    <style>
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #2a2a3e;
            --accent-bg: #1e1e3e;
            --primary-color: #667eea;
            --accent-color: #00ff88;
            --error-color: #ff4444;
            --warning-color: #ffa726;
            --text-primary: #eee;
            --text-secondary: #bbb;
            --border-color: #3a3a5e;
            --changed-color: #ffd700;
            --new-color: #00ff88;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            border-radius: 16px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            margin: 0;
            font-size: 3rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.95;
            font-size: 1.1rem;
        }

        .ai-badge {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-color);
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid var(--accent-color);
        }

        /* Email Status Widget */
        .email-status-widget {
            position: absolute;
            top: 15px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .email-status-widget:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .email-status-widget .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning-color);
            animation: pulse 2s infinite;
        }

        .email-status-widget.configured .indicator {
            background: var(--accent-color);
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .button {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            font-size: 16px;
        }

        .button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transition: left 0.3s ease;
        }

        .button:hover::before {
            left: 100%;
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-primary {
            background: linear-gradient(135deg, var(--accent-color) 0%, #00cc6a 100%);
            color: #000;
        }

        .button-secondary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
        }

        .button-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ff7043 100%);
            color: white;
        }

        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        /* Status Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .status-card {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .status-card:hover::before {
            transform: translateX(0);
        }

        .status-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .status-card h3 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 16px;
            font-weight: 600;
        }

        .status-card .value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-card .label {
            font-size: 13px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-card.clickable {
            cursor: pointer;
        }

        /* Main Content Tabs */
        .content-area {
            background: var(--secondary-bg);
            border-radius: 16px;
            padding: 30px;
            margin-top: 30px;
            min-height: 600px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .content-header h2 {
            margin: 0;
            font-size: 24px;
            color: var(--text-primary);
        }

        /* Companies List */
        .companies-list {
            display: grid;
            gap: 15px;
        }

        .company-item {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .company-item:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.2);
        }

        .company-info {
            flex: 1;
        }

        .company-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .company-urls {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .company-urls a {
            color: var(--primary-color);
            text-decoration: none;
            margin-right: 10px;
        }

        .company-urls a:hover {
            color: var(--accent-color);
        }

        .company-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* URLs List */
        .urls-list {
            display: grid;
            gap: 10px;
        }

        .url-item {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            align-items: center;
            gap: 15px;
            transition: all 0.2s ease;
        }

        .url-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: var(--primary-color);
        }

        .url-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
            word-break: break-all;
        }

        .url-link:hover {
            color: var(--accent-color);
        }

        .url-type {
            background: var(--primary-bg);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .url-status {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Loading and Messages */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .error-message, .success-message, .info-message {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: var(--error-color);
        }

        .success-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-color);
        }

        .info-message {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: var(--primary-color);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--secondary-bg);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .close {
            color: var(--text-secondary);
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }

        .close:hover {
            color: var(--text-primary);
        }

        /* Animations */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .company-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .company-stats {
                width: 100%;
                justify-content: space-around;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="email-status-widget" id="emailStatus" onclick="showEmailConfig()">
                <span class="indicator"></span>
                <span class="text">Email: Not Configured</span>
            </div>
            <div class="ai-badge">ü§ñ GitHub Actions Powered</div>
            <h1>AI Competitor Monitor</h1>
            <p>Advanced Intelligence & Real-time Competitive Analysis powered by GitHub Actions</p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button type="button" class="button button-primary" onclick="refreshStatus()">
                <span>üîÑ</span>
                <span>Refresh Status</span>
            </button>
            <button type="button" class="button button-secondary" onclick="triggerMonitor()">
                <span>üöÄ</span>
                <span>Trigger Monitor Run</span>
            </button>
            <button type="button" class="button button-warning" onclick="checkWorkflow()">
                <span>üìä</span>
                <span>Check Workflow Status</span>
            </button>
            <button type="button" class="button button-secondary" onclick="syncToTheBrain()">
                <span>üß†</span>
                <span>Sync to TheBrain</span>
            </button>
        </div>

        <!-- Status Grid -->
        <div class="status-grid" id="statusGrid">
            <div class="status-card clickable" onclick="showCompanies()">
                <h3>Companies Monitored</h3>
                <div class="value" id="companiesCount">--</div>
                <div class="label">COMPANIES</div>
            </div>
            <div class="status-card clickable" onclick="showUrls()">
                <h3>URLs Tracked</h3>
                <div class="value" id="urlsCount">--</div>
                <div class="label">URLS TRACKED</div>
            </div>
            <div class="status-card clickable" onclick="showRecentChecks()">
                <h3>Last Check</h3>
                <div class="value" id="lastCheck">--</div>
                <div class="label">LAST CHECK</div>
            </div>
            <div class="status-card">
                <h3>System Status</h3>
                <div class="value" id="systemStatus">üü¢</div>
                <div class="label">OPERATIONAL</div>
            </div>
            <div class="status-card clickable" onclick="showChanges()">
                <h3>Changes Today</h3>
                <div class="value" id="changesToday">--</div>
                <div class="label">24H CHANGES</div>
            </div>
            <div class="status-card">
                <h3>Backend Type</h3>
                <div class="value">üé¨</div>
                <div class="label">GITHUB ACTIONS</div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area" id="contentArea">
            <div class="content-header">
                <h2 id="contentTitle">Dashboard Overview</h2>
                <button type="button" class="button button-primary" onclick="refreshContent()" style="padding: 10px 20px; font-size: 14px;">
                    Refresh
                </button>
            </div>
            <div id="contentBody">
                <div class="loading">Loading dashboard data</div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody">
                <!-- Content will be dynamically inserted -->
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            dataUrl: './api-data',
            repoUrl: 'https://github.com/redmorestudio/ai-competitive-monitor',
            dashboardUrl: 'https://redmorestudio.github.io/ai-competitive-monitor',
            version: '2.0.0'
        };

        // Global state
        let currentView = 'dashboard';
        let dashboardData = null;
        let companiesData = [];
        let urlsData = [];
        let changesData = [];
        let emailStatus = { configured: false };

        // Initialize
        async function init() {
            console.log('üöÄ AI Competitive Monitor v2.0 - Initializing...');
            await refreshStatus();
            await checkEmailStatus();
            setInterval(refreshStatus, 30000); // Auto-refresh every 30 seconds
        }

        // Load static data
        async function loadData(filename) {
            try {
                const response = await fetch(`${CONFIG.dataUrl}/${filename}`);
                if (!response.ok) {
                    throw new Error(`Failed to load ${filename}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
                return null;
            }
        }

        // Refresh dashboard status
        async function refreshStatus() {
            console.log('üîÑ Refreshing dashboard status...');
            
            // Load dashboard data
            dashboardData = await loadData('dashboard.json');
            if (!dashboardData) {
                showError('Unable to load dashboard data. Please check if monitoring has run.');
                return;
            }

            // Update status cards
            document.getElementById('companiesCount').textContent = dashboardData.stats?.companies || '0';
            document.getElementById('urlsCount').textContent = dashboardData.stats?.urls || '0';
            
            // Calculate last check time
            if (dashboardData.generated_at) {
                const lastCheckTime = new Date(dashboardData.generated_at);
                document.getElementById('lastCheck').textContent = formatTimeAgo(lastCheckTime);
            }

            // Load changes data for today's count
            changesData = await loadData('changes.json');
            if (changesData && changesData.changes) {
                const today = new Date();
                const dayAgo = new Date(today - 24 * 60 * 60 * 1000);
                const todayChanges = changesData.changes.filter(c => 
                    new Date(c.created_at) > dayAgo
                ).length;
                document.getElementById('changesToday').textContent = todayChanges;
            }

            // Update current view
            updateContentView();
        }

        // Check email configuration status
        async function checkEmailStatus() {
            const emailSummary = await loadData('email-summary.json');
            if (emailSummary) {
                emailStatus = emailSummary;
                const widget = document.getElementById('emailStatus');
                if (emailSummary.email_configured) {
                    widget.classList.add('configured');
                    widget.querySelector('.text').textContent = `Email: ${emailSummary.recipient || 'Configured'}`;
                } else {
                    widget.querySelector('.text').textContent = 'Email: Not Configured';
                }
            }
        }

        // View management functions
        function showCompanies() {
            currentView = 'companies';
            document.getElementById('contentTitle').textContent = 'Companies Monitored';
            updateContentView();
        }

        function showUrls() {
            currentView = 'urls';
            document.getElementById('contentTitle').textContent = 'URLs Being Tracked';
            updateContentView();
        }

        function showRecentChecks() {
            currentView = 'checks';
            document.getElementById('contentTitle').textContent = 'Recent Monitoring Checks';
            updateContentView();
        }

        function showChanges() {
            currentView = 'changes';
            document.getElementById('contentTitle').textContent = 'Recent Changes Detected';
            updateContentView();
        }

        function showEmailConfig() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = 'Email Configuration';
            
            let html = '<div class="info-message">';
            if (emailStatus.email_configured) {
                html += `
                    <div>
                        <h3>‚úÖ Email Notifications Configured</h3>
                        <p><strong>Recipient:</strong> ${emailStatus.recipient}</p>
                        <p><strong>Daily Summary:</strong> Sent after morning run (9 AM UTC)</p>
                        <p><strong>High Priority Alerts:</strong> Sent immediately when detected</p>
                        <p><strong>Companies Monitored:</strong> ${emailStatus.companies_count || 0}</p>
                        <p><strong>Total URLs:</strong> ${emailStatus.total_urls || 0}</p>
                        <p><strong>Next Run:</strong> In approximately ${emailStatus.next_run_hours || '?'} hours</p>
                    </div>
                `;
            } else {
                html += `
                    <div>
                        <h3>üìß Email Notifications Not Configured</h3>
                        <p>To enable email notifications, add these GitHub Secrets:</p>
                        <ul style="text-align: left; margin: 20px 0;">
                            <li><code>SMTP_HOST</code> - Your SMTP server (e.g., smtp.gmail.com)</li>
                            <li><code>SMTP_PORT</code> - SMTP port (e.g., 587)</li>
                            <li><code>SMTP_USER</code> - Your email address</li>
                            <li><code>SMTP_PASS</code> - Your app password</li>
                            <li><code>NOTIFICATION_EMAIL</code> - Recipient email (optional)</li>
                        </ul>
                        <p>Once configured, you'll receive:</p>
                        <ul style="text-align: left;">
                            <li>Daily verification emails with all companies and URLs</li>
                            <li>Instant alerts for high-priority changes</li>
                            <li>New company addition notifications</li>
                        </ul>
                    </div>
                `;
            }
            html += '</div>';
            
            html += `
                <div style="text-align: center; margin-top: 30px;">
                    <a href="${CONFIG.repoUrl}/settings/secrets/actions" target="_blank" class="button button-primary">
                        Configure GitHub Secrets
                    </a>
                </div>
            `;
            
            modalBody.innerHTML = html;
            modal.style.display = 'block';
        }

        async function updateContentView() {
            const contentBody = document.getElementById('contentBody');
            
            switch (currentView) {
                case 'companies':
                    await displayCompanies();
                    break;
                case 'urls':
                    await displayUrls();
                    break;
                case 'checks':
                    await displayRecentChecks();
                    break;
                case 'changes':
                    await displayChanges();
                    break;
                default:
                    displayDashboard();
            }
        }

        function displayDashboard() {
            const contentBody = document.getElementById('contentBody');
            
            if (!dashboardData || !dashboardData.company_activity) {
                contentBody.innerHTML = '<div class="error-message">No dashboard data available. Please trigger a monitoring run.</div>';
                return;
            }
            
            let html = '<div class="companies-list">';
            
            dashboardData.company_activity.forEach(company => {
                const changeCount = company.change_count || 0;
                const avgRelevance = company.avg_relevance || 0;
                
                html += `
                    <div class="company-item" onclick="showCompanyDetails('${company.name}')">
                        <div class="company-info">
                            <div class="company-name">${company.name}</div>
                            <div class="company-urls">
                                Click to view URLs and recent activity
                            </div>
                        </div>
                        <div class="company-stats">
                            <div class="stat-item">
                                <div class="stat-value">${changeCount}</div>
                                <div class="stat-label">Changes</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${avgRelevance.toFixed(1)}</div>
                                <div class="stat-label">Avg Score</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentBody.innerHTML = html;
        }

        async function displayCompanies() {
            const contentBody = document.getElementById('contentBody');
            
            // Load content snapshots to get URL details
            const snapshots = await loadData('content-snapshots.json');
            if (!snapshots || !snapshots.extractedData) {
                contentBody.innerHTML = '<div class="error-message">No company data available.</div>';
                return;
            }

            // Group URLs by company
            const companiesMap = new Map();
            snapshots.extractedData.forEach(item => {
                if (!companiesMap.has(item.company)) {
                    companiesMap.set(item.company, {
                        name: item.company,
                        urls: new Set(),
                        lastCheck: null,
                        changeCount: 0
                    });
                }
                const company = companiesMap.get(item.company);
                company.urls.add(item.url);
                if (!company.lastCheck || new Date(item.timestamp) > new Date(company.lastCheck)) {
                    company.lastCheck = item.timestamp;
                }
            });

            // Add change counts if available
            if (changesData && changesData.changes) {
                changesData.changes.forEach(change => {
                    if (companiesMap.has(change.company)) {
                        companiesMap.get(change.company).changeCount++;
                    }
                });
            }

            let html = '<div class="companies-list">';
            
            Array.from(companiesMap.values()).sort((a, b) => a.name.localeCompare(b.name)).forEach(company => {
                html += `
                    <div class="company-item" onclick="showCompanyDetails('${company.name}')">
                        <div class="company-info">
                            <div class="company-name">${company.name}</div>
                            <div class="company-urls">
                                ${company.urls.size} URLs monitored ‚Ä¢ Last check: ${formatTimeAgo(new Date(company.lastCheck))}
                            </div>
                        </div>
                        <div class="company-stats">
                            <div class="stat-item">
                                <div class="stat-value">${company.urls.size}</div>
                                <div class="stat-label">URLs</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${company.changeCount}</div>
                                <div class="stat-label">Changes</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentBody.innerHTML = html;
        }

        async function displayUrls() {
            const contentBody = document.getElementById('contentBody');
            
            const snapshots = await loadData('content-snapshots.json');
            if (!snapshots || !snapshots.extractedData) {
                contentBody.innerHTML = '<div class="error-message">No URL data available.</div>';
                return;
            }

            // Group by URL to get latest info
            const urlsMap = new Map();
            snapshots.extractedData.forEach(item => {
                if (!urlsMap.has(item.url)) {
                    urlsMap.set(item.url, item);
                } else {
                    // Keep the latest snapshot
                    const existing = urlsMap.get(item.url);
                    if (new Date(item.timestamp) > new Date(existing.timestamp)) {
                        urlsMap.set(item.url, item);
                    }
                }
            });

            let html = '<div class="urls-list">';
            
            Array.from(urlsMap.values()).sort((a, b) => a.company.localeCompare(b.company)).forEach(item => {
                const lastCheck = formatTimeAgo(new Date(item.timestamp));
                const isRecent = (new Date() - new Date(item.timestamp)) < 24 * 60 * 60 * 1000;
                
                html += `
                    <div class="url-item" onclick="showUrlDetails('${item.url}')">
                        <div>
                            <a href="${item.url}" target="_blank" class="url-link" onclick="event.stopPropagation()">
                                ${item.url}
                            </a>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                ${item.company} ‚Ä¢ Last checked: ${lastCheck}
                            </div>
                        </div>
                        <div class="url-type">${item.type || 'general'}</div>
                        <div class="url-status">
                            ${isRecent ? '<span style="color: var(--accent-color);">‚úì Recent</span>' : '<span style="color: var(--text-secondary);">Checked</span>'}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentBody.innerHTML = html;
        }

        async function displayRecentChecks() {
            const contentBody = document.getElementById('contentBody');
            
            const runs = await loadData('monitoring-runs.json');
            if (!runs || !runs.logs) {
                contentBody.innerHTML = '<div class="error-message">No monitoring run data available.</div>';
                return;
            }

            let html = '<div class="info-message">Recent monitoring activity from GitHub Actions</div>';
            html += '<div style="background: var(--accent-bg); border-radius: 12px; padding: 20px; margin-top: 20px;">';
            
            runs.logs.slice(0, 20).forEach(log => {
                const time = new Date(log.timestamp).toLocaleString();
                const iconMap = {
                    'success': '‚úÖ',
                    'error': '‚ùå',
                    'info': '‚ÑπÔ∏è',
                    'warning': '‚ö†Ô∏è'
                };
                const icon = iconMap[log.type] || 'üìù';
                
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                        <div style="font-size: 12px; color: var(--text-secondary);">${time}</div>
                        <div style="margin-top: 5px;">${icon} ${log.message}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentBody.innerHTML = html;
        }

        async function displayChanges() {
            const contentBody = document.getElementById('contentBody');
            
            if (!changesData || !changesData.changes || changesData.changes.length === 0) {
                contentBody.innerHTML = '<div class="info-message">No changes detected in recent monitoring runs.</div>';
                return;
            }

            const today = new Date();
            const dayAgo = new Date(today - 24 * 60 * 60 * 1000);
            const recentChanges = changesData.changes.filter(c => new Date(c.created_at) > dayAgo);
            
            let html = `
                <div class="info-message">
                    ${recentChanges.length} changes in last 24 hours ‚Ä¢ ${changesData.changes.length} total changes tracked
                </div>
            `;

            html += '<div style="display: grid; gap: 15px; margin-top: 20px;">';
            
            changesData.changes.slice(0, 50).forEach(change => {
                const relevanceClass = change.relevance_score >= 7 ? 'error-message' : 
                                     change.relevance_score >= 4 ? 'info-message' : 'success-message';
                
                html += `
                    <div class="${relevanceClass}" style="cursor: pointer;" onclick="showChangeDetails(${JSON.stringify(change).replace(/"/g, '&quot;')})">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong>${change.company}</strong> - ${change.category || 'General Update'}
                                <div style="font-size: 14px; margin-top: 5px;">${change.summary || 'Content updated'}</div>
                                <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">
                                    ${new Date(change.created_at).toLocaleDateString()} ‚Ä¢ 
                                    Score: ${change.relevance_score}/10
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 20px; font-weight: bold;">${change.change_percentage || 0}%</div>
                                <div style="font-size: 12px;">change</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentBody.innerHTML = html;
        }

        // Detail view functions
        async function showCompanyDetails(companyName) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = companyName;
            
            // Load all data for this company
            const snapshots = await loadData('content-snapshots.json');
            const companyData = snapshots?.extractedData?.filter(item => item.company === companyName) || [];
            const companyChanges = changesData?.changes?.filter(c => c.company === companyName) || [];
            
            let html = `<div class="info-message">Monitoring ${companyData.length} snapshots across multiple URLs</div>`;
            
            // URLs section
            const urls = [...new Set(companyData.map(d => d.url))];
            html += '<h3 style="margin-top: 30px;">Monitored URLs</h3>';
            html += '<div class="urls-list">';
            urls.forEach(url => {
                const urlData = companyData.find(d => d.url === url);
                html += `
                    <div class="url-item">
                        <a href="${url}" target="_blank" class="url-link">${url}</a>
                        <div class="url-type">${urlData?.type || 'general'}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Recent changes
            if (companyChanges.length > 0) {
                html += '<h3 style="margin-top: 30px;">Recent Changes</h3>';
                companyChanges.slice(0, 10).forEach(change => {
                    html += `
                        <div class="info-message" style="margin: 10px 0;">
                            <div>
                                <strong>${change.category || 'Update'}</strong> - Score: ${change.relevance_score}/10
                                <div style="font-size: 14px; margin-top: 5px;">${change.summary || 'Content changed'}</div>
                                <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">
                                    ${new Date(change.created_at).toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            modalBody.innerHTML = html;
            modal.style.display = 'block';
        }

        function showUrlDetails(url) {
            // Implement URL details view
            showInfo(`URL details for: ${url}`);
        }

        function showChangeDetails(change) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = 'Change Details';
            
            let html = `
                <div class="${change.relevance_score >= 7 ? 'error-message' : 'info-message'}">
                    <strong>Relevance Score:</strong> ${change.relevance_score}/10
                </div>
                
                <div style="margin-top: 20px;">
                    <p><strong>Company:</strong> ${change.company}</p>
                    <p><strong>URL:</strong> <a href="${change.url}" target="_blank" class="url-link">${change.url}</a></p>
                    <p><strong>Category:</strong> ${change.category || 'General Update'}</p>
                    <p><strong>Change Percentage:</strong> ${change.change_percentage || 0}%</p>
                    <p><strong>Detected:</strong> ${new Date(change.created_at).toLocaleString()}</p>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>AI Analysis Summary</h3>
                    <p>${change.summary || 'No summary available'}</p>
                </div>
                
                ${change.competitive_threats ? `
                    <div style="margin-top: 20px;">
                        <h3>Competitive Threats</h3>
                        <p>${change.competitive_threats}</p>
                    </div>
                ` : ''}
                
                ${change.strategic_opportunities ? `
                    <div style="margin-top: 20px;">
                        <h3>Strategic Opportunities</h3>
                        <p>${change.strategic_opportunities}</p>
                    </div>
                ` : ''}
            `;
            
            modalBody.innerHTML = html;
            modal.style.display = 'block';
        }

        // Action functions
        function refreshContent() {
            updateContentView();
            showSuccess('Content refreshed');
        }

        function triggerMonitor() {
            showSuccess('Opening GitHub Actions workflow page...');
            window.open(`${CONFIG.repoUrl}/actions/workflows/monitor.yml`, '_blank');
        }

        function checkWorkflow() {
            showSuccess('Opening workflow runs...');
            window.open(`${CONFIG.repoUrl}/actions`, '_blank');
        }

        function syncToTheBrain() {
            showInfo('TheBrain sync runs automatically as part of the monitoring workflow.');
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Utility functions
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = [
                { label: 'year', seconds: 31536000 },
                { label: 'month', seconds: 2592000 },
                { label: 'week', seconds: 604800 },
                { label: 'day', seconds: 86400 },
                { label: 'hour', seconds: 3600 },
                { label: 'minute', seconds: 60 }
            ];
            
            for (const interval of intervals) {
                const count = Math.floor(seconds / interval.seconds);
                if (count > 0) {
                    return count === 1 ? `${count} ${interval.label} ago` : `${count} ${interval.label}s ago`;
                }
            }
            return 'just now';
        }

        function showError(message) {
            console.error('‚ùå', message);
            // Could implement toast notifications here
        }

        function showSuccess(message) {
            console.log('‚úÖ', message);
            // Could implement toast notifications here
        }

        function showInfo(message) {
            console.log('‚ÑπÔ∏è', message);
            // Could implement toast notifications here
        }

        // Modal close on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>