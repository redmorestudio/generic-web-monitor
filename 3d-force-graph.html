<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Competitive Monitor - 3D Force Graph</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #eee;
            overflow: hidden;
        }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(20, 20, 30, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            max-width: 300px;
            z-index: 100;
        }
        
        #info h3 {
            margin: 0 0 10px 0;
            color: #00ff88;
        }
        
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(20, 20, 30, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            z-index: 100;
        }
        
        .control-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 12px;
        }
        
        select, button {
            width: 100%;
            padding: 5px;
            background: #1a1a2e;
            color: #eee;
            border: 1px solid #333;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #2a2a3e;
            border-color: #00ff88;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: #00ff88;
        }
        
        .node-label {
            color: #fff !important;
            font-size: 12px !important;
            text-shadow: 0 0 3px #000;
        }
        
        #stats {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(20, 20, 30, 0.9);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #333;
            font-size: 12px;
            z-index: 100;
        }
    </style>
    <!-- Fixed CDN links with HTTPS and specific versions -->
    <script src="https://unpkg.com/three@0.152.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three-spritetext@1.8.0/dist/three-spritetext.min.js"></script>
    <script src="https://unpkg.com/3d-force-graph@1.73.0/dist/3d-force-graph.min.js"></script>
</head>
<body>
    <div id="loading">Loading AI Competitive Intelligence Graph...</div>
    <div id="info" style="display: none;">
        <h3>AI Competitive Monitor</h3>
        <div id="node-info">Hover over nodes for details</div>
    </div>
    
    <div id="controls" style="display: none;">
        <div class="control-group">
            <label>View Mode:</label>
            <select id="viewMode">
                <option value="companies">Company Network</option>
                <option value="technologies">Technology Landscape</option>
                <option value="concepts">AI/ML Concepts</option>
                <option value="changes">Recent Changes</option>
            </select>
        </div>
        <div class="control-group">
            <label>Filter by Type:</label>
            <select id="filterType">
                <option value="all">All Companies</option>
                <option value="LLM Providers">LLM Providers</option>
                <option value="AI Hardware">AI Hardware</option>
                <option value="AI Frameworks">AI Frameworks</option>
                <option value="Cloud Providers">Cloud Providers</option>
            </select>
        </div>
        <div class="control-group">
            <button id="toggleParticles">Toggle Particles</button>
        </div>
        <div class="control-group">
            <button id="resetView">Reset View</button>
        </div>
    </div>
    
    <div id="stats" style="display: none;">
        <div id="statsContent"></div>
    </div>
    
    <div id="3d-graph"></div>

    <script>
    // Configuration
    const CONFIG = {
        nodeColors: {
            'LLM Providers': '#ff6b6b',
            'AI Hardware': '#4ecdc4',
            'AI Frameworks': '#45b7d1',
            'Cloud Providers': '#96ceb4',
            'AI Applications': '#f7b731',
            'AI Research': '#5f27cd',
            'default': '#667eea'
        },
        threatColors: {
            'high': '#ff4444',
            'medium': '#ffa726',
            'low': '#66bb6a',
            'unknown': '#666666'
        },
        particleSpeed: 0.003,
        linkOpacity: 0.3,
        linkWidth: 0.5
    };

    let Graph;
    let graphData = { nodes: [], links: [] };
    let rawData = {};
    let particlesEnabled = true;
    let currentView = 'companies';

    // Initialize the graph
    async function initGraph() {
        try {
            // Fetch data
            const dashboardResponse = await fetch('./api-data/dashboard.json');
            const companiesResponse = await fetch('./api-data/companies.json');
            const changesResponse = await fetch('./api-data/changes.json');
            
            rawData = {
                dashboard: await dashboardResponse.json(),
                companies: await companiesResponse.json(),
                changes: await changesResponse.json()
            };
            
            // Build initial graph data
            buildCompanyNetwork();
            
            // Hide loading, show controls
            document.getElementById('loading').style.display = 'none';
            document.getElementById('info').style.display = 'block';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('stats').style.display = 'block';
            
            // Create the graph
            Graph = ForceGraph3D()
                (document.getElementById('3d-graph'))
                .graphData(graphData)
                .nodeLabel('label')
                .nodeAutoColorBy('group')
                .nodeThreeObject(node => {
                    const sprite = new SpriteText(node.name);
                    sprite.material.depthWrite = false;
                    sprite.color = node.color || '#ffffff';
                    sprite.textHeight = 6;
                    return sprite;
                })
                .linkWidth(link => link.width || CONFIG.linkWidth)
                .linkOpacity(CONFIG.linkOpacity)
                .linkDirectionalParticles(link => particlesEnabled ? link.particles || 2 : 0)
                .linkDirectionalParticleSpeed(CONFIG.particleSpeed)
                .linkDirectionalParticleWidth(2)
                .linkDirectionalParticleColor(link => link.color || '#ffffff')
                .onNodeHover(node => {
                    document.getElementById('node-info').innerHTML = node ? 
                        `<strong>${node.name}</strong><br/>
                         Type: ${node.group}<br/>
                         ${node.description || ''}` : 
                        'Hover over nodes for details';
                })
                .onNodeClick(node => {
                    // Focus on node
                    const distance = 200;
                    const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
                    
                    Graph.cameraPosition(
                        { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio },
                        node,
                        3000
                    );
                });
            
            // Set initial camera position
            Graph.cameraPosition({ z: 500 });
            
            updateStats();
            
        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('loading').innerHTML = 'Error loading data. Please ensure the API data is available.';
        }
    }

    // Build company network view
    function buildCompanyNetwork() {
        graphData.nodes = [];
        graphData.links = [];
        const nodeMap = new Map();
        
        // Create company nodes
        rawData.dashboard.company_activity.forEach(company => {
            const node = {
                id: company.company,
                name: company.company,
                group: company.type,
                color: CONFIG.nodeColors[company.type] || CONFIG.nodeColors.default,
                description: `URLs: ${company.url_count}<br/>Threat: ${company.intelligence.threat_category}`,
                val: company.url_count * 5, // Node size based on URL count
                threatLevel: company.intelligence.threat_level
            };
            graphData.nodes.push(node);
            nodeMap.set(company.company, node);
        });
        
        // Create technology/product connections
        const techConnections = new Map();
        
        rawData.dashboard.company_activity.forEach(company => {
            // Connect companies that share technologies
            company.intelligence.technologies.forEach(tech => {
                if (!techConnections.has(tech)) {
                    techConnections.set(tech, []);
                }
                techConnections.get(tech).push(company.company);
            });
        });
        
        // Create links between companies sharing technologies
        techConnections.forEach((companies, tech) => {
            if (companies.length > 1) {
                for (let i = 0; i < companies.length - 1; i++) {
                    for (let j = i + 1; j < companies.length; j++) {
                        graphData.links.push({
                            source: companies[i],
                            target: companies[j],
                            label: tech,
                            color: '#666',
                            particles: 1,
                            width: 0.5
                        });
                    }
                }
            }
        });
        
        // Add some AI concept connections
        const conceptConnections = new Map();
        rawData.dashboard.company_activity.forEach(company => {
            company.intelligence.ai_ml_concepts.forEach(concept => {
                if (!conceptConnections.has(concept)) {
                    conceptConnections.set(concept, []);
                }
                conceptConnections.get(concept).push(company.company);
            });
        });
        
        // Highlight strong concept connections
        conceptConnections.forEach((companies, concept) => {
            if (companies.length > 2) {
                // Create a central concept node
                const conceptNode = {
                    id: `concept-${concept}`,
                    name: concept,
                    group: 'AI Concept',
                    color: '#00ff88',
                    val: companies.length * 3,
                    description: `Shared by ${companies.length} companies`
                };
                graphData.nodes.push(conceptNode);
                
                // Connect companies to concept
                companies.forEach(company => {
                    graphData.links.push({
                        source: company,
                        target: conceptNode.id,
                        color: '#00ff88',
                        particles: 2,
                        width: 1
                    });
                });
            }
        });
    }

    // Build technology landscape view
    function buildTechnologyView() {
        graphData.nodes = [];
        graphData.links = [];
        
        const techNodes = new Map();
        
        // Create technology nodes
        rawData.dashboard.company_activity.forEach(company => {
            company.intelligence.technologies.forEach(tech => {
                if (!techNodes.has(tech)) {
                    techNodes.set(tech, {
                        id: `tech-${tech}`,
                        name: tech,
                        group: 'Technology',
                        color: '#4ecdc4',
                        companies: [],
                        val: 5
                    });
                }
                techNodes.get(tech).companies.push(company.company);
                techNodes.get(tech).val += 3;
            });
        });
        
        // Add technology nodes to graph
        techNodes.forEach(node => {
            node.description = `Used by ${node.companies.length} companies`;
            graphData.nodes.push(node);
        });
        
        // Add company nodes
        rawData.dashboard.company_activity.forEach(company => {
            graphData.nodes.push({
                id: company.company,
                name: company.company,
                group: company.type,
                color: CONFIG.nodeColors[company.type] || CONFIG.nodeColors.default,
                val: 3
            });
        });
        
        // Create links
        techNodes.forEach((techNode, tech) => {
            techNode.companies.forEach(company => {
                graphData.links.push({
                    source: techNode.id,
                    target: company,
                    particles: 1
                });
            });
        });
    }

    // Update statistics
    function updateStats() {
        const stats = rawData.dashboard.stats;
        document.getElementById('statsContent').innerHTML = `
            <strong>Monitoring Stats:</strong><br/>
            Companies: ${stats.companies}<br/>
            URLs: ${stats.urls}<br/>
            Snapshots: ${stats.snapshots}<br/>
            Nodes: ${graphData.nodes.length}<br/>
            Links: ${graphData.links.length}
        `;
    }

    // Event handlers
    document.getElementById('viewMode').addEventListener('change', (e) => {
        currentView = e.target.value;
        switch(currentView) {
            case 'technologies':
                buildTechnologyView();
                break;
            case 'companies':
            default:
                buildCompanyNetwork();
                break;
        }
        Graph.graphData(graphData);
        updateStats();
    });

    document.getElementById('filterType').addEventListener('change', (e) => {
        const filterType = e.target.value;
        if (filterType === 'all') {
            buildCompanyNetwork();
        } else {
            // Filter nodes
            const filteredNodes = graphData.nodes.filter(node => 
                node.group === filterType || node.group === 'AI Concept'
            );
            const nodeIds = new Set(filteredNodes.map(n => n.id));
            const filteredLinks = graphData.links.filter(link =>
                nodeIds.has(link.source.id || link.source) && 
                nodeIds.has(link.target.id || link.target)
            );
            
            Graph.graphData({ nodes: filteredNodes, links: filteredLinks });
        }
        updateStats();
    });

    document.getElementById('toggleParticles').addEventListener('click', () => {
        particlesEnabled = !particlesEnabled;
        graphData.links.forEach(link => {
            Graph.linkDirectionalParticles(link, particlesEnabled ? link.particles || 2 : 0);
        });
    });

    document.getElementById('resetView').addEventListener('click', () => {
        Graph.cameraPosition({ x: 0, y: 0, z: 500 }, { x: 0, y: 0, z: 0 }, 1000);
    });

    // Initialize on load
    initGraph();
    </script>
</body>
</html>