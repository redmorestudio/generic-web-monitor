<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Competitive Monitor - Advanced Intelligence Dashboard</title>
    <style>
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #2a2a3e;
            --accent-bg: #1e1e3e;
            --primary-color: #667eea;
            --accent-color: #00ff88;
            --error-color: #ff4444;
            --warning-color: #ffa726;
            --text-primary: #eee;
            --text-secondary: #bbb;
            --border-color: #3a3a5e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            border-radius: 12px;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            color: white;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .ai-badge {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .auth-section {
            background: var(--secondary-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .tabs {
            display: flex;
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
            min-width: 120px;
        }

        .tab:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-primary {
            background: linear-gradient(135deg, var(--accent-color) 0%, #00cc6a 100%);
            color: #000;
        }

        .button-secondary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
        }

        .button-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ff7043 100%);
            color: white;
        }

        .button-ai {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .status-card {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .status-card h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 14px;
        }

        .status-card .value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .status-card .label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .ai-features {
            background: var(--secondary-bg);
            border: 2px solid var(--accent-color);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .ai-features h3 {
            color: var(--accent-color);
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .feature-card {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .feature-card h4 {
            margin: 0 0 10px 0;
            color: var(--accent-color);
            font-size: 16px;
        }

        .feature-card p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }

        .config-section {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h4 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .threshold-config {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--secondary-bg);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--accent-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--primary-bg);
            color: var(--primary-color);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: var(--secondary-bg);
        }

        .log-container {
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-timestamp {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .log-level-info { color: #4a9eff; }
        .log-level-success { color: var(--accent-color); }
        .log-level-warning { color: var(--warning-color); }
        .log-level-error { color: var(--error-color); }

        .error-message, .success-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: var(--error-color);
        }

        .success-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .company-card {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .company-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .company-card h3 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
        }

        .company-card .url {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 14px;
            word-break: break-all;
        }

        .company-card .status {
            margin: 10px 0;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }

        .status-operational {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-color);
        }

        .status-error {
            background: rgba(255, 68, 68, 0.2);
            color: var(--error-color);
        }

        .status-checking {
            background: rgba(255, 167, 38, 0.2);
            color: var(--warning-color);
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="ai-badge">ü§ñ AI-Powered v55</div>
            <h1>AI Competitor Monitor</h1>
            <p>Advanced Intelligence & Real-time Competitive Analysis</p>
        </div>

        <!-- Authentication -->
        <div class="auth-section">
            <h3>üîê Authentication</h3>
            <p>Enter your API token to access the advanced monitoring system:</p>
            <div class="input-group">
                <input type="password" id="apiToken" placeholder="Enter API token" value="dev-token-change-me">
                <button id="saveTokenBtn" class="button button-primary" style="margin-top: 10px;" type="button">üíæ Save Token</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('extracted')">üìÑ Extracted Data</button>
            <button class="tab" onclick="showTab('changes')">üìà Change History</button>
            <button class="tab" onclick="showTab('configuration')">‚öôÔ∏è Configuration</button>
            <button class="tab" onclick="showTab('baseline')">üìä Baseline</button>
            <button class="tab" onclick="showTab('logs')">üìù System Logs</button>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="button button-primary" onclick="refreshStatus()">üîÑ Refresh Status</button>
            <button class="button button-secondary" onclick="generateBaseline()">üìä Generate Baseline</button>
            <button class="button button-warning" onclick="runMonitorCheck()">üîç Run Monitor Check</button>
            <button class="button button-ai" onclick="openTheBrain()">üß† TheBrain Integration</button>
        </div>

        <!-- System Status -->
        <div class="status-grid">
            <div class="status-card">
                <h3>System Status</h3>
                <div class="value" id="systemStatus">Loading...</div>
                <div class="label" id="statusMessage">CHECKING</div>
            </div>
            <div class="status-card">
                <h3>Companies Monitored</h3>
                <div class="value" id="companiesCount">--</div>
                <div class="label">COMPANIES</div>
            </div>
            <div class="status-card">
                <h3>URLs Tracked</h3>
                <div class="value" id="urlsCount">--</div>
                <div class="label">URLS TRACKED</div>
            </div>
            <div class="status-card">
                <h3>Last Check</h3>
                <div class="value" id="lastCheck">--</div>
                <div class="label">LAST CHECK</div>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="dashboard-tab" class="tab-content active">
            <h2>üéØ Intelligence Dashboard</h2>
            
            <!-- AI Intelligence Features -->
            <div class="ai-features">
                <h3>ü§ñ Advanced AI Intelligence Features</h3>
                <div class="feature-grid">
                    <div class="feature-card">
                        <h4>üéØ Change Magnitude Detection</h4>
                        <p>AI precisely calculates how much each page changed (5%, 25%, 50%+) using advanced content diffing algorithms</p>
                    </div>
                    <div class="feature-card">
                        <h4>üß† Claude Relevance Scoring (1-10)</h4>
                        <p>Claude AI evaluates the business importance and competitive significance of each detected change</p>
                    </div>
                    <div class="feature-card">
                        <h4>üé® Smart Content Extraction</h4>
                        <p>Intelligent CSS selectors and content parsing focused on strategic business content areas</p>
                    </div>
                    <div class="feature-card">
                        <h4>üìä Competitive Intelligence</h4>
                        <p>Automated detection of competitor mentions, feature launches, pricing changes, and strategic shifts</p>
                    </div>
                    <div class="feature-card">
                        <h4>‚öôÔ∏è Configurable Thresholds</h4>
                        <p>Custom sensitivity settings per company, page type, and content category for precise monitoring</p>
                    </div>
                    <div class="feature-card">
                        <h4>üß† TheBrain Integration</h4>
                        <p>Automatic knowledge mapping and relationship visualization of competitive intelligence</p>
                    </div>
                </div>
            </div>
            
            <div id="activityFeed">
                <div class="loading">üîÑ Loading competitive intelligence from advanced backend...</div>
            </div>
        </div>

        <div id="extracted-tab" class="tab-content">
            <h2>üìÑ Extracted Data Analysis</h2>
            <button class="button button-secondary" onclick="loadExtractedData()">üîÑ Refresh Extracted Data</button>
            
            <div id="extractedData">
                <div class="loading">Click "Refresh Extracted Data" to load content analysis...</div>
            </div>
        </div>

        <div id="changes-tab" class="tab-content">
            <h2>üìà Change History & Analysis</h2>
            <button class="button button-secondary" onclick="loadChangeHistory()">üîÑ Load Change History</button>
            
            <div id="changeHistory">
                <div class="loading">Click "Load Change History" to view historical changes...</div>
            </div>
        </div>

        <div id="configuration-tab" class="tab-content">
            <h2>‚öôÔ∏è Advanced Configuration</h2>
            <button class="button button-secondary" onclick="loadConfiguration()">üîÑ Load Configuration</button>
            
            <div id="configurationData">
                <div class="loading">Click "Load Configuration" to view system settings...</div>
            </div>
        </div>

        <div id="baseline-tab" class="tab-content">
            <h2>üìä Baseline Management</h2>
            <p>Generate and manage baseline snapshots for accurate change detection.</p>
            
            <button class="button button-primary" onclick="generateBaseline()">üöÄ Generate New Baseline</button>
            
            <div id="baselineResults">
                <div class="loading">Click "Generate New Baseline" to create baseline snapshots...</div>
            </div>
        </div>

        <div id="logs-tab" class="tab-content">
            <h2>üìù System Logs & Monitoring</h2>
            <button class="button button-secondary" onclick="loadSystemLogs()">üîÑ Refresh Logs</button>
            
            <div id="systemLogs">
                <div class="loading">Click "Refresh Logs" to load system logs...</div>
            </div>
        </div>
    </div>

    <script>
        // FIXED: Use correct Version 53 deployment with full functionality
        const CONFIG = {
            apiUrl: 'https://script.google.com/macros/s/AKfycbwC4ybmtlMW5O2ZFTucAo-We2fDFkFLz96eEEa5f1vj7ECqE8hJ18IktOgP0zu2m4a5JQ/exec',
            token: 'dev-token-change-me'
        };

        // Enhanced State Management - FIXED: Prevent infinite loops
        let currentData = null;
        let isLoading = false;
        let statusCheckTimeout = null;

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // FIXED: API Helper Function - Prevent infinite loops and use proper parameters
        async function apiCall(action, params = {}) {
            if (isLoading && action === 'status') {
                console.log('Status check already in progress');
                return { error: 'Status check in progress' };
            }

            try {
                if (action === 'status') isLoading = true;
                
                // Clear any existing timeout for status checks
                if (statusCheckTimeout) {
                    clearTimeout(statusCheckTimeout);
                    statusCheckTimeout = null;
                }
                
                const urlParams = new URLSearchParams({
                    action: action,
                    token: CONFIG.token,
                    ...params
                });
                
                console.log('Checking system status'); // Simplified logging to prevent console spam
                
                const response = await fetch(`${CONFIG.apiUrl}?${urlParams}`, {
                    method: 'GET',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API call failed:', error);
                return { error: error.message };
            } finally {
                if (action === 'status') isLoading = false;
            }
        }

        // FIXED: Enhanced Status Refresh - Prevent infinite loops
        async function refreshStatus() {
            if (isLoading) {
                console.log('Status refresh already in progress');
                return;
            }
            
            try {
                document.getElementById('systemStatus').textContent = 'Checking...';
                
                // Get comprehensive status from Version 53 backend
                const statusData = await apiCall('status');
                
                if (statusData.error) {
                    throw new Error(statusData.error);
                }
                
                // Update all status cards
                document.getElementById('systemStatus').textContent = statusData.status || 'Operational';
                document.getElementById('statusMessage').textContent = statusData.status === 'operational' ? 'OPERATIONAL' : 'ERROR';
                document.getElementById('companiesCount').textContent = statusData.companiesMonitored || statusData.companies || '--';
                document.getElementById('urlsCount').textContent = statusData.urlsTracked || statusData.urls || '--';
                
                if (statusData.lastCheck) {
                    const lastCheck = new Date(statusData.lastCheck);
                    document.getElementById('lastCheck').textContent = formatTimeAgo(lastCheck);
                } else {
                    document.getElementById('lastCheck').textContent = 'Never';
                }
                
                // Load latest data to populate dashboard - ONLY if not already loaded
                if (!currentData) {
                    await loadLatestData();
                }
                
            } catch (error) {
                console.error('Error refreshing status:', error);
                document.getElementById('systemStatus').textContent = 'Error';
                document.getElementById('statusMessage').textContent = 'ERROR';
                showError('Error loading status: ' + error.message);
            }
        }

        // Load Latest Data and Display Companies
        async function loadLatestData() {
            try {
                const data = await apiCall('config');
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentData = data;
                displayCompanies(data);
                
            } catch (error) {
                console.error('Error loading latest data:', error);
                showError('Error loading company data: ' + error.message);
            }
        }

        // Display Companies
        function displayCompanies(data) {
            const feedContainer = document.getElementById('activityFeed');
            
            if (!data || (!data.companies && !data.monitors && !data.config)) {
                feedContainer.innerHTML = '<div class="error-message">No company data available from backend</div>';
                return;
            }

            // Handle different response formats from backend
            let companies = data.companies || data.monitors || (data.config && data.config.monitors) || [];
            
            if (companies.length === 0) {
                feedContainer.innerHTML = '<div class="error-message">No companies configured in monitoring system</div>';
                return;
            }

            let html = '<h3>üìä Monitored Companies</h3><div class="companies-grid">';
            
            companies.forEach(company => {
                const companyName = company.company || company.name || 'Unknown';
                const urls = company.urls || [];
                const urlCount = Array.isArray(urls) ? urls.length : 0;
                
                html += `
                    <div class="company-card">
                        <h3>${companyName}</h3>
                        <div class="status status-operational">Active Monitoring</div>
                        <p><strong>URLs:</strong> ${urlCount}</p>
                        <div style="margin-top: 10px;">
                            ${urls.slice(0, 2).map(url => {
                                const urlString = typeof url === 'string' ? url : (url.url || '');
                                return `<div><a href="${urlString}" target="_blank" class="url">${urlString}</a></div>`;
                            }).join('')}
                            ${urlCount > 2 ? `<div style="color: #999; font-size: 12px;">+${urlCount - 2} more URLs</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            feedContainer.innerHTML = html;
        }

        // Generate Baseline
        async function generateBaseline() {
            const resultsDiv = document.getElementById('baselineResults');
            resultsDiv.innerHTML = '<div class="loading">Generating baseline snapshots...</div>';
            
            try {
                const result = await apiCall('baseline');
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                resultsDiv.innerHTML = `
                    <div class="success-message">
                        ‚úÖ Baseline generated successfully!<br>
                        ${result.message || 'Baseline snapshots created for all monitored URLs.'}
                        <br><br>
                        üìä Processed: ${result.processed || 0} URLs<br>
                        üìà Total: ${result.total || 0} URLs<br>
                        ${result.errors && result.errors.length > 0 ? `‚ö†Ô∏è Errors: ${result.errors.length}` : ''}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error generating baseline:', error);
                resultsDiv.innerHTML = `<div class="error-message">Error generating baseline: ${error.message}</div>`;
            }
        }

        // Run Monitor Check
        async function runMonitorCheck() {
            try {
                showSuccess('Running comprehensive monitor check...');
                const result = await apiCall('monitor');
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                showSuccess(`‚úÖ Monitor check completed! ${result.message || 'Check finished successfully.'}`);
                // Refresh status after check
                setTimeout(refreshStatus, 1000);
                
            } catch (error) {
                console.error('Error running monitor check:', error);
                showError('Error running monitor check: ' + error.message);
            }
        }

        // Load Extracted Data
        async function loadExtractedData() {
            const container = document.getElementById('extractedData');
            container.innerHTML = '<div class="loading">Loading extracted data...</div>';
            
            try {
                const data = await apiCall('extracted');
                
                if (data.error) {
                    container.innerHTML = '<div class="error-message">No extracted data available</div>';
                    return;
                }
                
                // Display extracted data in table format
                if (data.data && data.data.length > 0) {
                    let html = '<table class="data-table"><thead><tr><th>Company</th><th>URL</th><th>Content Preview</th><th>Status</th></tr></thead><tbody>';
                    data.data.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.company}</td>
                                <td><a href="${item.url}" target="_blank" class="url">${item.url}</a></td>
                                <td>${item.extractedContent || 'No content'}</td>
                                <td><span class="status status-operational">${item.status || 'Available'}</span></td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="error-message">No extracted data available</div>';
                }
                
            } catch (error) {
                container.innerHTML = `<div class="error-message">Error loading extracted data: ${error.message}</div>`;
            }
        }

        // Load Change History
        async function loadChangeHistory() {
            const container = document.getElementById('changeHistory');
            container.innerHTML = '<div class="loading">Loading change history...</div>';
            
            try {
                const data = await apiCall('changes');
                
                if (data.error) {
                    container.innerHTML = '<div class="error-message">No change history available</div>';
                    return;
                }
                
                if (data.changes && data.changes.length > 0) {
                    let html = '<h3>üìà Recent Changes</h3>';
                    data.changes.forEach(change => {
                        html += `
                            <div class="config-section">
                                <h4>${change.company}</h4>
                                <p><strong>URL:</strong> <a href="${change.url}" target="_blank" class="url">${change.url}</a></p>
                                <p><strong>Description:</strong> ${change.description}</p>
                                <p><strong>Timestamp:</strong> ${new Date(change.timestamp).toLocaleString()}</p>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="success-message">No recent changes detected</div>';
                }
                
            } catch (error) {
                container.innerHTML = `<div class="error-message">Error loading change history: ${error.message}</div>`;
            }
        }

        // Load Configuration
        async function loadConfiguration() {
            const container = document.getElementById('configurationData');
            container.innerHTML = '<div class="loading">Loading configuration...</div>';
            
            try {
                const data = await apiCall('config');
                
                if (data.error) {
                    container.innerHTML = '<div class="error-message">No configuration available</div>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="config-section">
                        <h4>üìä System Configuration</h4>
                        <pre style="background: var(--primary-bg); padding: 15px; border-radius: 8px; overflow-x: auto; color: var(--text-primary);">
${JSON.stringify(data, null, 2)}
                        </pre>
                    </div>
                `;
                
            } catch (error) {
                container.innerHTML = `<div class="error-message">Error loading configuration: ${error.message}</div>`;
            }
        }

        // Load System Logs
        async function loadSystemLogs() {
            const container = document.getElementById('systemLogs');
            container.innerHTML = '<div class="loading">Loading system logs...</div>';
            
            try {
                const data = await apiCall('logs');
                
                if (data.error) {
                    container.innerHTML = '<div class="error-message">Unable to load system logs</div>';
                    return;
                }
                
                if (data.logs && data.logs.length > 0) {
                    let html = '<div class="log-container">';
                    data.logs.forEach(log => {
                        html += `
                            <div class="log-entry">
                                <div class="log-timestamp">${new Date(log.timestamp).toLocaleString()}</div>
                                <div class="log-level-${log.level}">${log.message}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="success-message">No recent logs available</div>';
                }
                
            } catch (error) {
                container.innerHTML = `<div class="error-message">Error loading system logs: ${error.message}</div>`;
            }
        }

        // TheBrain Integration
        function openTheBrain() {
            showSuccess('üß† Opening TheBrain integration...');
            window.open('https://thebrain.com', '_blank');
        }

        // Save Token - FIXED: Prevent infinite loops
        let isSavingToken = false;
        function saveToken(event) {
            // Prevent any default behavior and event bubbling
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (isSavingToken) {
                console.log('Token save already in progress');
                return;
            }
            
            isSavingToken = true;
            const token = document.getElementById('apiToken').value;
            CONFIG.token = token;
            
            // Save to localStorage to persist
            localStorage.setItem('apiToken', token);
            
            // Use console.log instead of repeated showSuccess calls
            console.log('Token saved successfully');
            showSuccess('üíæ API token saved successfully!');
            
            // Reset flag after a delay
            setTimeout(() => {
                isSavingToken = false;
            }, 1000);
            
            // Return false to prevent any further processing
            return false;
        }

        // Utility Functions
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = [
                { label: 'year', seconds: 31536000 },
                { label: 'month', seconds: 2592000 },
                { label: 'week', seconds: 604800 },
                { label: 'day', seconds: 86400 },
                { label: 'hour', seconds: 3600 },
                { label: 'minute', seconds: 60 }
            ];
            
            for (const interval of intervals) {
                const count = Math.floor(seconds / interval.seconds);
                if (count > 0) {
                    return count === 1 ? `${count} ${interval.label} ago` : `${count} ${interval.label}s ago`;
                }
            }
            return 'just now';
        }

        function showError(message) {
            const existing = document.querySelector('.error-message.temp');
            if (existing) existing.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message temp';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.tabs'));
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            // FIXED: Prevent DOM mutation loops with debouncing
            // Clear any existing timeout
            if (window.successTimeout) {
                clearTimeout(window.successTimeout);
            }
            
            // Remove any existing success messages
            const existingMessages = document.querySelectorAll('.success-message.temp');
            existingMessages.forEach(msg => msg.remove());
            
            // Create new message
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message temp';
            successDiv.textContent = message;
            
            // Use requestAnimationFrame to ensure DOM is ready
            requestAnimationFrame(() => {
                const container = document.querySelector('.container');
                const tabs = document.querySelector('.tabs');
                if (container && tabs && !document.querySelector('.success-message.temp')) {
                    container.insertBefore(successDiv, tabs);
                }
                
                // Remove after delay
                window.successTimeout = setTimeout(() => {
                    if (successDiv && successDiv.parentNode) {
                        successDiv.remove();
                    }
                }, 3000);
            });
        }

        // FIXED: Initialize - Prevent infinite loops and use proper Version 53 backend
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ AI Competitive Monitor v55 - Initializing...');
            console.log('API Endpoint:', CONFIG.apiUrl);
            console.log('Using Version 53 deployment with full intelligent monitoring features');
            
            // FIXED: Add proper event listener for save token button
            const saveTokenBtn = document.getElementById('saveTokenBtn');
            if (saveTokenBtn) {
                // Remove any existing listeners first
                saveTokenBtn.removeEventListener('click', saveToken);
                // Add the event listener with proper handling
                saveTokenBtn.addEventListener('click', saveToken, { once: false });
            }
            
            // Load saved token if exists
            const savedToken = localStorage.getItem('apiToken');
            if (savedToken) {
                document.getElementById('apiToken').value = savedToken;
                CONFIG.token = savedToken;
            }
            
            // Only run initial status check ONCE
            refreshStatus();
        });
    </script>
</body>
</html>