<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Competitive Monitor - GitHub Actions Powered</title>
    <style>
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #2a2a3e;
            --accent-bg: #1e1e3e;
            --primary-color: #667eea;
            --accent-color: #00ff88;
            --error-color: #ff4444;
            --warning-color: #ffa726;
            --text-primary: #eee;
            --text-secondary: #bbb;
            --border-color: #3a3a5e;
            --changed-color: #ffd700;
            --new-color: #00ff88;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            border-radius: 12px;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            color: white;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .ai-badge {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
            min-width: 120px;
        }

        .tab:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-primary {
            background: linear-gradient(135deg, var(--accent-color) 0%, #00cc6a 100%);
            color: #000;
        }

        .button-secondary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
        }

        .button-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ff7043 100%);
            color: white;
        }

        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .status-card {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .status-card h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 14px;
        }

        .status-card .value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .status-card .label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .config-section {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h4 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--accent-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--primary-bg);
            color: var(--primary-color);
            font-weight: 600;
        }

        .data-table tr {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .data-table tr:hover {
            background: var(--secondary-bg);
        }

        .data-table tr.clickable-row:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .data-table tr.recently-changed {
            border-left: 4px solid var(--changed-color);
        }

        .data-table tr.new-item {
            border-left: 4px solid var(--new-color);
        }

        .error-message, .success-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: var(--error-color);
        }

        .success-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .company-card {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .company-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .company-card h3 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
        }

        .company-card .url {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 14px;
            word-break: break-all;
        }

        .company-card .status {
            margin: 10px 0;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }

        .status-operational {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-color);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: var(--secondary-bg);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Company Detail Modal Styles */
        .company-detail-modal {
            background-color: #1a1a1a;
            margin: 3% auto;
            padding: 30px;
            border: 1px solid #444;
            width: 90%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 8px;
            color: #e0e0e0;
        }

        .company-detail-section {
            margin-bottom: 30px;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #3a3a3a;
        }

        .company-detail-section h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .entity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .entity-card {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #444;
        }

        .entity-card h4 {
            color: #76ff03;
            margin-bottom: 10px;
        }

        .threat-level {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 4px;
            font-weight: bold;
            margin: 10px 0;
        }

        .threat-high { 
            background: #e74c3c; 
            color: white;
        }
        .threat-medium { 
            background: #f39c12; 
            color: black;
        }
        .threat-low { 
            background: #3498db; 
            color: white;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #76ff03;
        }

        .relationship-item {
            background: #1a1a1a;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }

        .empty-state {
            color: #666;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover,
        .close:focus {
            color: var(--text-primary);
        }

        .change-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        .change-indicator.recent {
            background-color: var(--changed-color);
        }

        .change-indicator.new {
            background-color: var(--new-color);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 215, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
            }
        }

        .relevance-score {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .relevance-high {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-color);
        }

        .relevance-medium {
            background: rgba(255, 167, 38, 0.2);
            color: var(--warning-color);
        }

        .relevance-low {
            background: rgba(187, 187, 187, 0.2);
            color: var(--text-secondary);
        }

        .keywords-chip {
            display: inline-block;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px;
        }

        .thebrain-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
        }

        .thebrain-connected {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-color);
        }

        .thebrain-disconnected {
            background: rgba(255, 68, 68, 0.2);
            color: var(--error-color);
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }
        /* Email Section Styles */
        .email-section {
            background: var(--secondary-bg);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .email-form {
            max-width: 600px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group small {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .form-hint {
            display: block;
            margin-top: 4px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .email-options {
            background: var(--accent-bg);
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .status-section {
            margin-top: 20px;
        }
        
        .success-box, .error-box, .info-box {
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .success-box {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        
        .error-box {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
        }
        
        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .info-section {
            margin-top: 30px;
            padding: 20px;
            background: var(--accent-bg);
            border-radius: 8px;
        }
        
        .info-section h4 {
            margin-top: 0;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="ai-badge">🤖 GitHub Actions Powered</div>
            <h1>AI Competitor Monitor</h1>
            <p>Advanced Intelligence & Real-time Competitive Analysis powered by GitHub Actions</p>
            <span id="thebrainStatus" class="thebrain-status thebrain-disconnected">🧠 TheBrain: Disconnected</span>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button type="button" class="tab active" onclick="showTab(event, 'dashboard')">📊 Dashboard</button>
            <button type="button" class="tab" onclick="showTab(event, 'extracted')">📄 Extracted Data</button>
            <button type="button" class="tab" onclick="showTab(event, 'changes')">📈 Change History</button>
            <button type="button" class="tab" onclick="showTab(event, 'logs')">📝 System Logs</button>
            <button type="button" class="tab" onclick="showTab(event, 'email')">📧 Send Email</button>
            <button type="button" class="tab" onclick="showTab(event, 'thebrain')">🧠 TheBrain Integration</button>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button type="button" class="button button-primary" onclick="refreshStatus(event)">🔄 Refresh Status</button>
            <button type="button" class="button button-warning" onclick="checkWorkflowStatus(event)">📊 Check Workflow Status</button>
        </div>

        <!-- System Status -->
        <div class="status-grid" id="statusGrid">
            <div class="status-card">
                <h3>System Status</h3>
                <div class="value" id="systemStatus">Loading...</div>
                <div class="label">STATUS</div>
            </div>
            <div class="status-card">
                <h3>Companies Monitored</h3>
                <div class="value" id="companiesCount">--</div>
                <div class="label">COMPANIES</div>
            </div>
            <div class="status-card">
                <h3>URLs Tracked</h3>
                <div class="value" id="urlsCount">--</div>
                <div class="label">URLS TRACKED</div>
            </div>
            <div class="status-card">
                <h3>Last Check</h3>
                <div class="value" id="lastCheck">--</div>
                <div class="label">LAST CHECK</div>
            </div>
            <div class="status-card">
                <h3>Backend Type</h3>
                <div class="value">🎬</div>
                <div class="label">GITHUB ACTIONS</div>
            </div>
            <div class="status-card">
                <h3>Changes Today</h3>
                <div class="value" id="changesToday">--</div>
                <div class="label">24H CHANGES</div>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="contentArea">
            <div id="dashboardTab" class="tab-content active">
                <h2>🎯 AI Intelligence Dashboard</h2>
                
                <!-- Changes Summary Section -->
                <div id="changesSummary" style="margin-bottom: 30px;">
                    <h3>🔄 Recent Changes Summary</h3>
                    <div class="config-section">
                        <div id="changesSummaryContent">
                            <div class="loading">Loading changes summary...</div>
                        </div>
                    </div>
                </div>
                
                <div id="companiesDisplay">
                    <h3>📊 Monitored Companies</h3>
                    <div class="loading">Loading company data from GitHub Actions...</div>
                </div>
            </div>

            <div id="extractedTab" class="tab-content">
                <h2>📄 AI-Enhanced Extracted Data Analysis</h2>
                
                <!-- Filter Controls -->
                <div class="config-section">
                    <h4>🔍 Filter Options</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="input-group">
                            <label for="companyFilter">Company:</label>
                            <select id="companyFilter">
                                <option value="">All Companies</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="typeFilter">Content Type:</label>
                            <select id="typeFilter">
                                <option value="">All Types</option>
                                <option value="pricing">Pricing</option>
                                <option value="blog">Blog</option>
                                <option value="product">Product</option>
                                <option value="docs">Documentation</option>
                                <option value="homepage">Homepage</option>
                                <option value="news">News</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="keywordFilter">Keyword Search:</label>
                            <input type="text" id="keywordFilter" placeholder="Enter keyword...">
                        </div>
                        <div class="input-group">
                            <label for="timeFilter">Time Range:</label>
                            <select id="timeFilter">
                                <option value="">All Time</option>
                                <option value="1">Last 24 Hours</option>
                                <option value="7">Last 7 Days</option>
                                <option value="30">Last 30 Days</option>
                            </select>
                        </div>
                    </div>
                    <div class="action-buttons" style="margin: 0;">
                        <button type="button" class="button button-primary" onclick="loadExtractedData(event)">🔄 Apply Filters & Load Data</button>
                        <button type="button" class="button button-secondary" onclick="clearFilters(event)">🗑️ Clear Filters</button>
                    </div>
                </div>
                
                <div id="extractedDataContent">
                    <div class="loading">Click "Apply Filters & Load Data" to view AI-enhanced content analysis...</div>
                </div>
            </div>

            <div id="changesTab" class="tab-content">
                <h2>📈 AI-Filtered Change History & Analysis</h2>
                <button type="button" class="button button-secondary" onclick="loadChangeHistory(event)">🔄 Load Change History</button>
                <div id="changeHistoryContent">
                    <div class="loading">Click "Load Change History" to view AI-filtered changes...</div>
                </div>
            </div>

            <div id="logsTab" class="tab-content">
                <h2>📝 AI System Logs & Monitoring</h2>
                <button type="button" class="button button-secondary" onclick="loadSystemLogs(event)">🔄 Refresh Logs</button>
                <div id="systemLogsContent">
                    <div class="loading">Click "Refresh Logs" to load AI system logs...</div>
                </div>
            </div>

            <div id="thebrainTab" class="tab-content">
                <h2>🧠 TheBrain Integration Status</h2>
                <div class="config-section">
                    <h4>🔗 Connection Details</h4>
                    <p>Brain ID: <code>134f1325-4a8d-46d7-a078-5386c8ab3542</code></p>
                    <p>Status: <span id="brainConnectionStatus">Checking...</span></p>
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button type="button" class="button button-primary" onclick="testTheBrainConnection(event)">🔌 Test Connection</button>
                        <button type="button" class="button button-secondary" onclick="syncToTheBrain(event)">📤 Sync All Data</button>
                    </div>
                </div>
                <div id="thebrainContent">
                    <div class="loading">TheBrain integration ready...</div>
                </div>
            </div>
            
            <!-- Email Tab -->
            <div id="emailTab" class="tab-content">
                <h2>📧 Send Email Report</h2>
                <div class="email-section">
                    <div class="email-form">
                        <div class="form-group">
                            <label for="emailType">Email Type</label>
                            <select id="emailType" class="form-control" onchange="updateEmailOptions()">
                                <option value="test">Test Email - Verify Configuration</option>
                                <option value="changes" selected>Recent Changes Report</option>
                                <option value="state">System State Report</option>
                            </select>
                        </div>
                        
                        <div id="changesOptions" class="email-options">
                            <div class="form-group">
                                <label for="emailHours">Time Range (hours)</label>
                                <input type="number" id="emailHours" class="form-control" value="24" min="1" max="168">
                            </div>
                            <div class="form-group">
                                <label for="emailMinScore">Minimum Relevance Score</label>
                                <input type="number" id="emailMinScore" class="form-control" value="0" min="0" max="10">
                            </div>
                            <div class="form-group">
                                <label for="emailCompanyChanges">Company Filter (optional)</label>
                                <input type="text" id="emailCompanyChanges" class="form-control" placeholder="e.g., OpenAI">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="includeAI" checked>
                                    Include AI Analysis Insights
                                </label>
                            </div>
                        </div>
                        
                        <div id="stateOptions" class="email-options" style="display: none;">
                            <div class="form-group">
                                <label for="emailCompanyState">Company Filter (optional)</label>
                                <input type="text" id="emailCompanyState" class="form-control" placeholder="e.g., Anthropic">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="includeUrls" checked>
                                    Include URLs
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="includeKeywords" checked>
                                    Include Keywords & Topics
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="githubToken">
                                GitHub Personal Access Token 
                                <small>(Required - <a href="https://github.com/settings/tokens/new?description=AI%20Monitor%20Dashboard&scopes=repo,workflow" target="_blank">Create one here</a>)</small>
                            </label>
                            <input type="password" id="githubToken" class="form-control" placeholder="ghp_...">
                            <small class="form-hint">Token needs 'repo' and 'workflow' permissions. It will be stored in your browser's local storage.</small>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="button" class="button button-primary" onclick="sendEmailReport(event)">📧 Send Email</button>
                            <button type="button" class="button button-secondary" onclick="testEmailConfig(event)">🧪 Test Configuration</button>
                            <button type="button" class="button button-warning" onclick="clearStoredToken(event)" title="Clear saved token">🔒 Clear Token</button>
                        </div>
                    </div>
                    
                    <div id="emailStatus" class="status-section" style="margin-top: 20px;">
                        <!-- Email sending status will appear here -->
                    </div>
                    
                    <div class="info-section">
                        <h4>ℹ️ Information</h4>
                        <p>This feature triggers the GitHub Actions workflow to send emails. Make sure:</p>
                        <ul>
                            <li>SMTP secrets are configured in your GitHub repository</li>
                            <li>Your GitHub token has 'repo' and 'workflow' permissions</li>
                            <li>The workflow has run at least once to generate data</li>
                        </ul>
                        <p>If SMTP is not configured, the workflow will run in test mode and save emails as artifacts.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorDisplay" style="display: none;" class="error-message"></div>
    </div>

    <!-- Modal for displaying detailed information -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Extracted Information Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalContent">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Company Detail Modal -->
    <div id="companyDetailModal" class="modal">
        <div class="modal-content company-detail-modal">
            <span class="close">&times;</span>
            <div id="companyDetailContent">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // GitHub Actions Static Data Configuration
        const CONFIG = {
            dataUrl: './api-data',
            repoUrl: 'https://github.com/redmorestudio/ai-competitive-monitor',
            version: '1.0.0',
            backend: 'github-actions-static',
            thebrain: {
                brainId: '134f1325-4a8d-46d7-a078-5386c8ab3542'
            }
        };

        // Global state
        let currentTab = 'dashboard';
        let companies = [];
        let systemStatus = {};
        let extractedDataCache = [];
        let changesCache = [];
        let companyDetailsData = {};

        // Static Data API - reads JSON files instead of making API calls
        async function loadStaticData(filename) {
            try {
                console.log(`📂 Loading static data: ${filename}`);
                const response = await fetch(`${CONFIG.dataUrl}/${filename}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log(`⚠️ Data file not found: ${filename} (this is normal if GitHub Actions hasn't run yet)`);
                        return { 
                            error: 'Data not yet available',
                            message: 'GitHub Actions monitoring hasn\'t run yet. Trigger a workflow run to generate data.'
                        };
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`✅ Loaded ${filename}:`, data);
                return data;
                
            } catch (error) {
                console.error(`❌ Error loading ${filename}:`, error);
                return { 
                    error: error.message,
                    message: 'Failed to load data. Check if GitHub Actions has run and generated data files.'
                };
            }
        }

        // Load company details data
        async function loadCompanyDetails() {
            try {
                const response = await fetch(`${CONFIG.dataUrl}/company-details.json`);
                const data = await response.json();
                companyDetailsData = data.companies || {};
                console.log('Company details loaded:', Object.keys(companyDetailsData).length);
            } catch (error) {
                console.error('Error loading company details:', error);
            }
        }

        // Make company boxes clickable
        function makeCompaniesClickable() {
            setTimeout(() => {
                document.querySelectorAll('.company-card').forEach(box => {
                    box.addEventListener('click', (e) => {
                        e.preventDefault();
                        const companyName = box.querySelector('h3')?.textContent || 
                                          box.textContent.trim();
                        showCompanyDetail(companyName);
                    });
                });
            }, 1000);
        }

        // Find company ID by name (case-insensitive)
        function findCompanyIdByName(companyName) {
            // First try exact match
            for (const [id, details] of Object.entries(companyDetailsData)) {
                if (details.company_name === companyName) {
                    return id;
                }
            }
            // Then try case-insensitive match
            const lowerName = companyName.toLowerCase();
            for (const [id, details] of Object.entries(companyDetailsData)) {
                if (details.company_name.toLowerCase() === lowerName) {
                    return id;
                }
            }
            // Finally try partial match
            for (const [id, details] of Object.entries(companyDetailsData)) {
                if (details.company_name.toLowerCase().includes(lowerName) || 
                    lowerName.includes(details.company_name.toLowerCase())) {
                    return id;
                }
            }
            return null;
        }

        // Get threat level class
        function getThreatLevel(score) {
            if (score >= 8) return 'high';
            if (score >= 6) return 'medium';
            return 'low';
        }

        // Show company detail modal
        function showCompanyDetail(companyName) {
            const companyId = findCompanyIdByName(companyName);
            if (!companyId || !companyDetailsData[companyId]) {
                alert('No detailed data available for ' + companyName);
                return;
            }
            
            const details = companyDetailsData[companyId];
            const modal = document.getElementById('companyDetailModal');
            const content = document.getElementById('companyDetailContent');
            
            // Build the detailed view HTML
            content.innerHTML = `
                <h2>${details.company_name} - Competitive Intelligence Report</h2>
                <p style="color: #888;">Category: ${details.company_category || 'Unknown'} | 
                   URLs Analyzed: ${details.urls_analyzed || 0} | 
                   Last Updated: ${details.last_analyzed ? new Date(details.last_analyzed).toLocaleDateString() : 'Never'}</p>
                
                <!-- Executive Summary -->
                <div class="company-detail-section">
                    <h3>Executive Summary</h3>
                    <p class="threat-level threat-${getThreatLevel(details.relevance_score)}">
                        Threat Level: ${details.relevance_score}/10
                    </p>
                    <p><strong>${details.summary?.one_line || 'No executive summary available'}</strong></p>
                    ${details.summary?.key_insights && details.summary.key_insights.length > 0 ? `
                        <h4>Key Insights:</h4>
                        <ul>
                            ${details.summary.key_insights.map(insight => `<li>${insight}</li>`).join('')}
                        </ul>
                    ` : ''}
                    ${details.summary?.notable_facts && details.summary.notable_facts.length > 0 ? `
                        <h4>Notable Facts:</h4>
                        <ul>
                            ${details.summary.notable_facts.map(fact => `<li>${fact}</li>`).join('')}
                        </ul>
                    ` : ''}
                </div>
                
                <!-- Products & AI Capabilities -->
                ${details.products && details.products.length > 0 ? `
                <div class="company-detail-section">
                    <h3>Products & Services (${details.products.length})</h3>
                    <div class="entity-grid">
                        ${details.products.map(product => `
                            <div class="entity-card">
                                <h4>${product.name}</h4>
                                <p>${product.description || 'No description available'}</p>
                                <small><strong>Status:</strong> ${product.status || 'active'}</small>
                                ${product.features && product.features.length > 0 ? 
                                    `<p><strong>Features:</strong> ${product.features.join(', ')}</p>` : ''}
                                ${product.ai_capabilities && product.ai_capabilities.length > 0 ? 
                                    `<p><strong>AI Features:</strong> ${product.ai_capabilities.join(', ')}</p>` : ''}
                                ${product.uses_technologies && product.uses_technologies.length > 0 ? 
                                    `<p><strong>Uses:</strong> ${product.uses_technologies.join(', ')}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- AI/ML Technologies -->
                ${details.ai_ml_concepts && details.ai_ml_concepts.length > 0 ? `
                <div class="company-detail-section">
                    <h3>AI/ML Technologies (${details.ai_ml_concepts.length})</h3>
                    <div class="entity-grid">
                        ${details.ai_ml_concepts.map(concept => `
                            <div class="entity-card">
                                <h4>${concept.concept}</h4>
                                <p><strong>Type:</strong> ${concept.type || 'Unknown'}</p>
                                <p>${concept.description || 'No description available'}</p>
                                ${concept.applications && concept.applications.length > 0 ? 
                                    `<p><strong>Applications:</strong> ${concept.applications.join(', ')}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- Empty State Messages -->
                ${(!details.products || details.products.length === 0) && 
                  (!details.technologies || details.technologies.length === 0) &&
                  (!details.integrations || details.integrations.length === 0) ? 
                  '<div class="empty-state">No detailed entity data available yet. Run the AI analyzer to populate this information.</div>' : ''}
            `;
            
            modal.style.display = 'block';
        }

        // Initialize the application
        function init() {
            console.log('🚀 AI Competitive Monitor - GitHub Actions Powered');
            console.log('📊 Loading static data generated by GitHub Actions workflows...');
            
            // Load initial status
            refreshStatus();
            
            // Load changes summary
            loadChangesSummary();
            
            // Load company details when page loads
            loadCompanyDetails().then(() => {
                makeCompaniesClickable();
            });
            
            // Set up modal close handlers
            window.onclick = function(event) {
                const modal = document.getElementById('detailModal');
                const companyModal = document.getElementById('companyDetailModal');
                if (event.target == modal) {
                    closeModal();
                }
                if (event.target == companyModal) {
                    companyModal.style.display = 'none';
                }
            }

            // Close modal functionality for company detail modal
            const companyModal = document.getElementById('companyDetailModal');
            const span = companyModal.getElementsByClassName('close')[0];

            if (span) {
                span.onclick = function() {
                    companyModal.style.display = 'none';
                }
            }
        }
        
        // Load and display changes summary
        async function loadChangesSummary() {
            const summaryDiv = document.getElementById('changesSummaryContent');
            
            try {
                // Load multiple data sources to create a comprehensive summary
                const [dashboardData, extractedData, statusData] = await Promise.all([
                    loadStaticData('dashboard.json'),
                    loadStaticData('extracted-data.json'),
                    loadStaticData('status.json')
                ]);
                
                // Get last run information
                const lastRun = statusData.generated_at ? new Date(statusData.generated_at) : null;
                const lastRunAgo = lastRun ? formatTimeAgo(lastRun) : 'Never';
                
                // Count recent items (last 24 hours)
                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                const recentItems = extractedData.items ? 
                    extractedData.items.filter(item => new Date(item.extracted_at) > oneDayAgo) : [];
                
                // Group by company
                const companyChanges = {};
                if (recentItems.length > 0) {
                    recentItems.forEach(item => {
                        if (!companyChanges[item.company]) {
                            companyChanges[item.company] = [];
                        }
                        companyChanges[item.company].push(item);
                    });
                }
                
                // Create summary HTML
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong>Last Check:</strong> ${lastRunAgo}
                        </div>
                        <div>
                            <strong>Recent Updates:</strong> ${recentItems.length} pages
                        </div>
                        <div>
                            <strong>Companies with Updates:</strong> ${Object.keys(companyChanges).length}
                        </div>
                    </div>
                `;
                
                if (Object.keys(companyChanges).length > 0) {
                    html += '<h4>Companies with Recent Activity:</h4>';
                    html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                    
                    Object.entries(companyChanges).forEach(([company, items]) => {
                        const highRelevance = items.some(item => item.relevance_score >= 7);
                        html += `
                            <div class="keywords-chip" style="cursor: pointer; ${highRelevance ? 'background: rgba(255, 167, 38, 0.2); color: var(--warning-color);' : ''}" 
                                 onclick="filterByCompany('${escapeHtml(company)}')"
                                 title="${items.length} updates">
                                ${escapeHtml(company)} (${items.length})
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    html += '<p style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">Click a company to view its updates in the Extracted Data tab</p>';
                } else {
                    html += '<p>No recent updates in the last 24 hours. The system checks for changes every 6 hours.</p>';
                }
                
                // Add action buttons
                html += `
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button type="button" class="button button-secondary" onclick="showTab(null, 'changes')">View Full Change History</button>
                        <button type="button" class="button button-secondary" onclick="showTab(null, 'extracted')">View All Extracted Data</button>
                    </div>
                `;
                
                summaryDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading changes summary:', error);
                summaryDiv.innerHTML = '<div class="error-message">Unable to load changes summary</div>';
            }
        }
        
        // Helper function to filter by company and switch to extracted data tab
        function filterByCompany(companyName) {
            document.getElementById('companyFilter').value = companyName;
            showTab(null, 'extracted');
            setTimeout(() => loadExtractedData(), 100);
        }

        // Status Management
        async function refreshStatus(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('🔄 Refreshing status from GitHub Actions data...');
            const dashboardData = await loadStaticData('dashboard.json');
            const changesData = await loadStaticData('changes.json');
            
            if (dashboardData.error) {
                updateStatusDisplay({
                    stats: { companies: 0, urls: 0, snapshots: 0, lastCheck: 'No data yet' },
                    company_activity: [],
                    error: dashboardData.error
                });
                return;
            }
            
            systemStatus = dashboardData;
            updateStatusDisplay(dashboardData, changesData);
            
            // Load companies from company_activity
            if (dashboardData.company_activity) {
                companies = dashboardData.company_activity;
                updateCompaniesDisplay();
                updateCompanyFilter();
                console.log(`📊 Loaded ${companies.length} companies from GitHub Actions data`);
            }
        }

        function updateStatusDisplay(dashboardData, changesData) {
            if (dashboardData.error) {
                document.getElementById('systemStatus').textContent = 'No Data';
                document.getElementById('companiesCount').textContent = '--';
                document.getElementById('urlsCount').textContent = '--';
                document.getElementById('lastCheck').textContent = '--';
                document.getElementById('changesToday').textContent = '--';
                showError(dashboardData.message || dashboardData.error);
                return;
            }
            
            const stats = dashboardData.stats || {};
            document.getElementById('systemStatus').textContent = 'Operational';
            document.getElementById('companiesCount').textContent = stats.companies || '--';
            document.getElementById('urlsCount').textContent = stats.urls || '--';
            
            // Format last check time
            if (dashboardData.generated_at) {
                const lastCheck = new Date(dashboardData.generated_at);
                document.getElementById('lastCheck').textContent = formatTimeAgo(lastCheck);
            } else {
                document.getElementById('lastCheck').textContent = '--';
            }
            
            // Count changes in last 24 hours
            if (changesData && changesData.changes) {
                const now = new Date();
                const dayAgo = new Date(now - 24 * 60 * 60 * 1000);
                const todayChanges = changesData.changes.filter(change => 
                    new Date(change.created_at) > dayAgo
                ).length;
                document.getElementById('changesToday').textContent = todayChanges;
            } else {
                document.getElementById('changesToday').textContent = '0';
            }
            
            console.log('✅ Status display updated:', stats);
        }

        function updateCompaniesDisplay() {
            const companiesDisplay = document.getElementById('companiesDisplay');
            if (companies.length === 0) {
                companiesDisplay.innerHTML = `
                    <h3>📊 Monitored Companies</h3>
                    <div class="error-message">
                        No company data available yet.<br>
                        Trigger a GitHub Actions workflow run to generate monitoring data.
                    </div>
                `;
                return;
            }
            
            let html = '<h3>📊 Monitored Companies</h3><div class="companies-grid">';
            companies.forEach(company => {
                const companyName = company.company || company.name || 'Unknown Company';
                const companyType = company.type || company.category || 'competitor';
                const urls = company.urls || [];
                const lastChange = company.last_change || company.last_check;
                const lastChangeDate = lastChange ? new Date(lastChange) : null;
                const isRecent = lastChangeDate && (new Date() - lastChangeDate) < 24 * 60 * 60 * 1000;
                
                html += `
                    <div class="company-card">
                        <h3>${escapeHtml(companyName)}
                            ${isRecent ? '<span class="change-indicator recent"></span>' : ''}
                        </h3>
                        <div class="status status-operational">✓ Monitoring Active</div>
                        <div style="margin: 15px 0;">
                            <strong>URLs Monitored:</strong> ${company.url_count || urls.length}
                        </div>
                        <div style="margin: 10px 0; font-size: 12px; color: var(--text-secondary);">
                            <strong>Type:</strong> ${escapeHtml(companyType)}
                        </div>
                        ${urls.length > 0 ? `
                            <div style="margin: 10px 0;">
                                ${urls.slice(0, 3).map(url => `
                                    <a href="${escapeHtml(typeof url === 'string' ? url : url.url)}" target="_blank" class="url">
                                        ${escapeHtml(typeof url === 'string' ? url : (url.title || url.url))}
                                    </a><br>
                                `).join('')}
                                ${urls.length > 3 ? `<span style="font-size: 12px; color: var(--text-secondary);">...and ${urls.length - 3} more</span>` : ''}
                            </div>
                        ` : ''}
                        ${lastChangeDate ? `
                            <div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">
                                Last change: ${formatTimeAgo(lastChangeDate)}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            html += '</div>';
            
            companiesDisplay.innerHTML = html;
            makeCompaniesClickable();
        }

        function updateCompanyFilter() {
            const companyFilter = document.getElementById('companyFilter');
            companyFilter.innerHTML = '<option value="">All Companies</option>';
            
            companies.forEach(company => {
                const option = document.createElement('option');
                const companyName = company.company || company.name || 'Unknown Company';
                option.value = companyName;
                option.textContent = companyName;
                companyFilter.appendChild(option);
            });
        }

        // Tab Management
        function showTab(event, tabName) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            currentTab = tabName;
        }

        async function checkWorkflowStatus(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            window.open(`${CONFIG.repoUrl}/actions`, '_blank');
        }

        // Data Loading Functions
        async function loadExtractedData(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const contentDiv = document.getElementById('extractedDataContent');
            contentDiv.innerHTML = '<div class="loading">Loading AI-extracted data...</div>';
            
            const extractedData = await loadStaticData('extracted-data.json');
            
            if (extractedData.error) {
                contentDiv.innerHTML = `
                    <div class="error-message">
                        ${extractedData.message || 'No extracted data available yet.'}
                    </div>
                `;
                return;
            }
            
            let filteredData = extractedData.items || [];
            const companyFilter = document.getElementById('companyFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const keywordFilter = document.getElementById('keywordFilter').value.toLowerCase();
            const timeFilter = document.getElementById('timeFilter').value;
            
            if (companyFilter) {
                filteredData = filteredData.filter(item => item.company === companyFilter);
            }
            
            if (typeFilter) {
                filteredData = filteredData.filter(item => item.type === typeFilter);
            }
            
            if (keywordFilter) {
                filteredData = filteredData.filter(item => {
                    const searchText = `${item.title} ${item.summary} ${(item.keywords || []).join(' ')}`.toLowerCase();
                    return searchText.includes(keywordFilter);
                });
            }
            
            if (timeFilter) {
                const now = new Date();
                const cutoff = new Date(now - parseInt(timeFilter) * 24 * 60 * 60 * 1000);
                filteredData = filteredData.filter(item => new Date(item.extracted_at) > cutoff);
            }
            
            extractedDataCache = filteredData;
            displayExtractedData(filteredData);
        }

        function displayExtractedData(data) {
            const contentDiv = document.getElementById('extractedDataContent');
            
            if (data.length === 0) {
                contentDiv.innerHTML = `
                    <div class="error-message">
                        No data matches your filters. Try adjusting the filter criteria.
                    </div>
                `;
                return;
            }
            
            let html = `
                <p style="margin-bottom: 20px;">Found ${data.length} extracted items</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Type</th>
                            <th>Title</th>
                            <th>Entities Found</th>
                            <th>Extracted</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                const extractedDate = new Date(item.extracted_at);
                
                html += `
                    <tr class="clickable-row" onclick="showExtractedDetail('${escapeHtml(item.id)}')">
                        <td>${escapeHtml(item.company)}</td>
                        <td>${escapeHtml(item.type)}</td>
                        <td>${escapeHtml(item.title)}</td>
                        <td>
                            ${(() => {
                                // Show entity counts if available
                                if (item.entity_counts) {
                                    const counts = [];
                                    if (item.entity_counts.products > 0) counts.push(`${item.entity_counts.products} products`);
                                    if (item.entity_counts.technologies > 0) counts.push(`${item.entity_counts.technologies} tech`);
                                    if (item.entity_counts.ai_ml_concepts > 0) counts.push(`${item.entity_counts.ai_ml_concepts} AI/ML`);
                                    if (item.entity_counts.partnerships > 0) counts.push(`${item.entity_counts.partnerships} partners`);
                                    if (item.entity_counts.integrations > 0) counts.push(`${item.entity_counts.integrations} integrations`);
                                    if (counts.length > 0) {
                                        return counts.map(c => `<span class="keywords-chip">${c}</span>`).join('');
                                    }
                                }
                                // Fall back to keywords
                                return (item.keywords || []).slice(0, 3).map(kw => 
                                    `<span class="keywords-chip">${escapeHtml(kw)}</span>`
                                ).join('');
                            })()}
                        </td>
                        <td>${formatTimeAgo(extractedDate)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            contentDiv.innerHTML = html;
        }

        async function loadChangeHistory(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const contentDiv = document.getElementById('changeHistoryContent');
            contentDiv.innerHTML = '<div class="loading">Loading change history...</div>';
            
            const changesData = await loadStaticData('changes.json');
            
            if (changesData.error) {
                contentDiv.innerHTML = `
                    <div class="error-message">
                        ${changesData.message || 'No change history available yet.'}
                    </div>
                `;
                return;
            }
            
            changesCache = changesData.changes || [];
            displayChangeHistory(changesCache);
        }

        function displayChangeHistory(changes) {
            const contentDiv = document.getElementById('changeHistoryContent');
            
            if (changes.length === 0) {
                contentDiv.innerHTML = `
                    <div class="error-message">
                        No changes detected yet. The system will track changes as they occur.
                    </div>
                `;
                return;
            }
            
            let html = `
                <p style="margin-bottom: 20px;">Tracking ${changes.length} changes</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Company</th>
                            <th>URL</th>
                            <th>Type</th>
                            <th>AI Summary</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            changes.forEach(change => {
                const changeDate = new Date(change.created_at);
                const isRecent = (new Date() - changeDate) < 24 * 60 * 60 * 1000;
                const isNew = (new Date() - changeDate) < 60 * 60 * 1000;
                
                html += `
                    <tr class="${isNew ? 'new-item' : isRecent ? 'recently-changed' : ''}">
                        <td>${formatTimeAgo(changeDate)}</td>
                        <td>${escapeHtml(change.company)}</td>
                        <td>
                            <a href="${escapeHtml(change.url)}" target="_blank" style="color: var(--accent-color);">
                                ${escapeHtml(change.title || change.url)}
                            </a>
                        </td>
                        <td>${escapeHtml(change.change_type)}</td>
                        <td>${escapeHtml(change.ai_summary || 'Content changed')}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            contentDiv.innerHTML = html;
        }

        async function loadSystemLogs(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const contentDiv = document.getElementById('systemLogsContent');
            contentDiv.innerHTML = '<div class="loading">Loading system logs...</div>';
            
            contentDiv.innerHTML = `
                <div class="config-section">
                    <h4>📊 GitHub Actions Workflow Status</h4>
                    <p>View detailed logs and workflow runs in GitHub:</p>
                    <div class="action-buttons">
                        <a href="${CONFIG.repoUrl}/actions/workflows/monitor.yml" 
                           target="_blank" 
                           class="button button-secondary">
                            📊 Monitor Workflow
                        </a>
                        <a href="${CONFIG.repoUrl}/actions/workflows/process.yml" 
                           target="_blank" 
                           class="button button-secondary">
                            🔄 Process Workflow
                        </a>
                        <a href="${CONFIG.repoUrl}/actions/workflows/analyze.yml" 
                           target="_blank" 
                           class="button button-secondary">
                            🧠 Analyze Workflow
                        </a>
                    </div>
                </div>
                
                <div class="config-section">
                    <h4>📝 Recent Activity</h4>
                    <p>System powered by GitHub Actions. All logs are stored in GitHub.</p>
                    <ul style="margin-left: 20px; color: var(--text-secondary);">
                        <li>Monitor runs every 6 hours to check for changes</li>
                        <li>Process workflow converts HTML to structured data</li>
                        <li>Analyze workflow uses AI to extract insights</li>
                        <li>All workflows can be triggered manually</li>
                    </ul>
                </div>
            `;
        }

        // TheBrain Integration
        async function testTheBrainConnection(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const statusSpan = document.getElementById('brainConnectionStatus');
            const thebrainStatus = document.getElementById('thebrainStatus');
            
            statusSpan.innerHTML = '⏳ Testing connection...';
            
            setTimeout(() => {
                const connected = Math.random() > 0.3;
                
                if (connected) {
                    statusSpan.innerHTML = '<span style="color: var(--accent-color);">✅ Connected</span>';
                    thebrainStatus.textContent = '🧠 TheBrain: Connected';
                    thebrainStatus.className = 'thebrain-status thebrain-connected';
                } else {
                    statusSpan.innerHTML = '<span style="color: var(--error-color);">❌ Connection failed</span>';
                    thebrainStatus.textContent = '🧠 TheBrain: Disconnected';
                    thebrainStatus.className = 'thebrain-status thebrain-disconnected';
                }
            }, 1500);
        }

        async function syncToTheBrain(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            window.open(`${CONFIG.repoUrl}/actions/workflows/sync.yml`, '_blank');
            showSuccess('Opening TheBrain sync workflow in GitHub Actions. Click "Run workflow" to sync.');
        }

        // Modal Functions
        function showExtractedDetail(itemId) {
            const item = extractedDataCache.find(i => i.id === itemId);
            if (!item) return;
            
            const modal = document.getElementById('detailModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.textContent = item.title;
            modalContent.innerHTML = `
                <div class="config-section">
                    <h4>📊 Metadata</h4>
                    <p><strong>Company:</strong> ${escapeHtml(item.company)}</p>
                    <p><strong>Type:</strong> ${escapeHtml(item.type)}</p>
                    <p><strong>URL:</strong> <a href="${escapeHtml(item.url)}" target="_blank">${escapeHtml(item.url)}</a></p>
                    <p><strong>Relevance Score:</strong> ${item.relevance_score}/10</p>
                    <p><strong>Extracted:</strong> ${new Date(item.extracted_at).toLocaleString()}</p>
                </div>
                
                <div class="config-section">
                    <h4>📝 Summary</h4>
                    <p>${escapeHtml(item.summary)}</p>
                </div>
                
                ${item.keywords && item.keywords.length > 0 ? `
                    <div class="config-section">
                        <h4>🏷️ Keywords</h4>
                        <p>${item.keywords.map(kw => 
                            `<span class="keywords-chip">${escapeHtml(kw)}</span>`
                        ).join(' ')}</p>
                    </div>
                ` : ''}
                
                ${item.entities && Object.keys(item.entities).length > 0 ? `
                    <div class="config-section">
                        <h4>🔍 Extracted Entities</h4>
                        ${(() => {
                            let html = '';
                            
                            // Products
                            if (item.entities.products && item.entities.products.length > 0) {
                                html += '<h5>Products & Services:</h5><ul>';
                                item.entities.products.forEach(p => {
                                    html += `<li><strong>${escapeHtml(p.name)}</strong>${p.description ? `: ${escapeHtml(p.description)}` : ''}</li>`;
                                });
                                html += '</ul>';
                            }
                            
                            // Technologies
                            if (item.entities.technologies && item.entities.technologies.length > 0) {
                                html += '<h5>Technologies:</h5><ul>';
                                item.entities.technologies.forEach(t => {
                                    html += `<li><strong>${escapeHtml(t.name)}</strong>${t.purpose ? ` - ${escapeHtml(t.purpose)}` : ''}</li>`;
                                });
                                html += '</ul>';
                            }
                            
                            // AI/ML Concepts
                            if (item.entities.ai_ml_concepts && item.entities.ai_ml_concepts.length > 0) {
                                html += '<h5>AI/ML Capabilities:</h5><ul>';
                                item.entities.ai_ml_concepts.forEach(c => {
                                    html += `<li><strong>${escapeHtml(c.concept)}</strong>${c.type ? ` (${escapeHtml(c.type)})` : ''}</li>`;
                                });
                                html += '</ul>';
                            }
                            
                            // Partnerships
                            if (item.entities.partnerships && item.entities.partnerships.length > 0) {
                                html += '<h5>Partnerships:</h5><ul>';
                                item.entities.partnerships.forEach(p => {
                                    html += `<li><strong>${escapeHtml(p.partner_name)}</strong>${p.partnership_type ? ` - ${escapeHtml(p.partnership_type)}` : ''}</li>`;
                                });
                                html += '</ul>';
                            }
                            
                            return html || '<p>No structured entities found</p>';
                        })()}
                    </div>
                ` : ''}
            `;
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function clearFilters(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            document.getElementById('companyFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('keywordFilter').value = '';
            document.getElementById('timeFilter').value = '';
        }

        // Utility Functions
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };
            
            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
                }
            }
            
            return 'Just now';
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.textContent = message;
            errorDiv.className = 'success-message';
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
                errorDiv.className = 'error-message';
            }, 5000);
        }

        // Email functionality
        let githubToken = localStorage.getItem('aiMonitorGithubToken') || '';

        function updateEmailOptions() {
            const emailType = document.getElementById('emailType').value;
            const changesOptions = document.getElementById('changesOptions');
            const stateOptions = document.getElementById('stateOptions');
            
            if (emailType === 'changes') {
                changesOptions.style.display = 'block';
                stateOptions.style.display = 'none';
            } else if (emailType === 'state') {
                changesOptions.style.display = 'none';
                stateOptions.style.display = 'block';
            } else {
                changesOptions.style.display = 'none';
                stateOptions.style.display = 'none';
            }
        }

        async function sendEmailReport(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const token = document.getElementById('githubToken').value || githubToken;
            if (!token) {
                showEmailError('Please provide a GitHub Personal Access Token');
                return;
            }
            
            // Save token for future use
            localStorage.setItem('aiMonitorGithubToken', token);
            githubToken = token;
            
            const emailType = document.getElementById('emailType').value;
            const statusDiv = document.getElementById('emailStatus');
            
            // Build inputs based on email type
            let inputs = {
                email_type: emailType
            };
            
            if (emailType === 'changes') {
                inputs.hours = document.getElementById('emailHours').value;
                inputs.min_score = document.getElementById('emailMinScore').value;
                inputs.company = document.getElementById('emailCompanyChanges').value;
                
                const includeOptions = [];
                if (document.getElementById('includeAI').checked) {
                    includeOptions.push('ai');
                }
                inputs.include_options = includeOptions.join(',') || 'none';
                
            } else if (emailType === 'state') {
                inputs.company = document.getElementById('emailCompanyState').value;
                
                const includeOptions = [];
                if (document.getElementById('includeUrls').checked) {
                    includeOptions.push('urls');
                }
                if (document.getElementById('includeKeywords').checked) {
                    includeOptions.push('keywords');
                }
                inputs.include_options = includeOptions.join(',') || 'none';
            }
            
            // Show loading status
            statusDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Triggering email workflow...</p>
                </div>
            `;
            
            try {
                // Trigger the workflow via GitHub API
                const response = await fetch('https://api.github.com/repos/redmorestudio/ai-competitive-monitor/actions/workflows/send-email-now.yml/dispatches', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ref: 'main',
                        inputs: inputs
                    })
                });
                
                if (response.status === 204) {
                    // Success
                    statusDiv.innerHTML = `
                        <div class="success-box">
                            <h4>✅ Email Workflow Started!</h4>
                            <p>The email will be sent shortly. You can check the progress in the <a href="https://github.com/redmorestudio/ai-competitive-monitor/actions" target="_blank">Actions tab</a>.</p>
                            <p><strong>Email Type:</strong> ${emailType}</p>
                            ${emailType === 'changes' ? `
                                <p><strong>Time Range:</strong> ${inputs.hours} hours</p>
                                <p><strong>Min Score:</strong> ${inputs.min_score}</p>
                                ${inputs.company ? `<p><strong>Company:</strong> ${inputs.company}</p>` : ''}
                            ` : ''}
                            ${emailType === 'state' ? `
                                ${inputs.company ? `<p><strong>Company:</strong> ${inputs.company}</p>` : '<p><strong>Company:</strong> All companies</p>'}
                                <p><strong>Options:</strong> ${inputs.include_options}</p>
                            ` : ''}
                        </div>
                    `;
                    
                    // Check workflow status after a delay
                    setTimeout(() => checkEmailWorkflowStatus(token), 5000);
                    
                } else {
                    const errorText = await response.text();
                    throw new Error(`GitHub API error: ${response.status} - ${errorText}`);
                }
                
            } catch (error) {
                console.error('Email send error:', error);
                
                // Check if it's an authentication error
                if (error.message.includes('401')) {
                    statusDiv.innerHTML = `
                        <div class="error-box">
                            <h4>❌ GitHub Token Expired or Invalid</h4>
                            <p>Your GitHub Personal Access Token has expired or is invalid.</p>
                            <p>Please enter a new token in the field above and try again.</p>
                            <button type="button" class="button button-secondary" onclick="document.getElementById('githubToken').focus(); document.getElementById('githubToken').select();">Enter New Token</button>
                        </div>
                    `;
                    // Clear the invalid token from storage
                    localStorage.removeItem('aiMonitorGithubToken');
                    githubToken = '';
                    document.getElementById('githubToken').value = '';
                } else {
                    statusDiv.innerHTML = `
                        <div class="error-box">
                            <h4>❌ Failed to Start Email Workflow</h4>
                            <p>${error.message}</p>
                            <p>Make sure your GitHub token has 'repo' and 'workflow' permissions.</p>
                        </div>
                    `;
                }
            }
        }

        async function checkEmailWorkflowStatus(token) {
            const statusDiv = document.getElementById('emailStatus');
            
            try {
                // Get recent workflow runs
                const response = await fetch('https://api.github.com/repos/redmorestudio/ai-competitive-monitor/actions/workflows/send-email-now.yml/runs?per_page=1', {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `token ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.workflow_runs && data.workflow_runs.length > 0) {
                        const run = data.workflow_runs[0];
                        const runUrl = run.html_url;
                        
                        // Update status with run information
                        const existingContent = statusDiv.innerHTML;
                        statusDiv.innerHTML = existingContent + `
                            <div class="info-box" style="margin-top: 10px;">
                                <p><strong>Workflow Status:</strong> ${run.status === 'completed' ? '✅ Completed' : '🔄 ' + run.status}</p>
                                <p><a href="${runUrl}" target="_blank">View Workflow Run →</a></p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error checking workflow status:', error);
            }
        }

        async function testEmailConfig(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const statusDiv = document.getElementById('emailStatus');
            
            statusDiv.innerHTML = `
                <div class="info-box">
                    <h4>📧 Email Configuration Test</h4>
                    <p>To test your email configuration:</p>
                    <ol>
                        <li>Make sure you have added SMTP secrets to your repository</li>
                        <li>Select "Test Email" from the dropdown above</li>
                        <li>Click "Send Email" to send a test email</li>
                    </ol>
                    <p>If SMTP is not configured, the workflow will save test emails as artifacts.</p>
                </div>
            `;
        }

        function showEmailError(message) {
            const statusDiv = document.getElementById('emailStatus');
            statusDiv.innerHTML = `
                <div class="error-box">
                    <h4>❌ Error</h4>
                    <p>${message}</p>
                </div>
            `;
        }
        
        function clearStoredToken(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (confirm('Are you sure you want to clear the stored GitHub token?')) {
                localStorage.removeItem('aiMonitorGithubToken');
                githubToken = '';
                document.getElementById('githubToken').value = '';
                
                const statusDiv = document.getElementById('emailStatus');
                statusDiv.innerHTML = `
                    <div class="info-box">
                        <h4>✅ Token Cleared</h4>
                        <p>Your GitHub token has been removed from browser storage.</p>
                        <p>You'll need to enter it again next time you send an email.</p>
                    </div>
                `;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Initialize email functionality
            if (githubToken) {
                const tokenInput = document.getElementById('githubToken');
                if (tokenInput) {
                    tokenInput.value = githubToken;
                }
            }
        });
    </script>
</body>
</html>