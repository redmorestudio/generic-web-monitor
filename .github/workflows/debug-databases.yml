name: Debug Database State

on:
  workflow_dispatch:

jobs:
  debug-databases:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd github-actions-backend
          npm install
      
      - name: Run database diagnostic
        run: |
          cd github-actions-backend
          node debug-database-state.js
      
      - name: Check specific database content
        run: |
          cd github-actions-backend
          echo "=== Checking if baseline_analysis has recent data ==="
          sqlite3 data/intelligence.db "SELECT datetime(created_at) as date, COUNT(*) as count FROM baseline_analysis GROUP BY date(created_at) ORDER BY date DESC LIMIT 10;" || echo "No baseline_analysis data"
          
          echo -e "\n=== Checking if markdown_content has recent data ==="
          sqlite3 data/processed_content.db "SELECT datetime(processed_at) as date, COUNT(*) as count FROM markdown_content GROUP BY date(processed_at) ORDER BY date DESC LIMIT 10;" || echo "No markdown_content data"
          
          echo -e "\n=== Checking companies and URLs ==="
          sqlite3 data/intelligence.db "SELECT COUNT(*) as company_count FROM companies;" || echo "No companies"
          sqlite3 data/intelligence.db "SELECT COUNT(*) as url_count FROM urls;" || echo "No urls"
