name: 🔧 Fix Remaining Array Columns (Targeted)

on:
  workflow_dispatch:
    inputs: {}

jobs:
  fix-remaining-columns:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        cd github-actions-backend
        npm install

    - name: 🔧 Execute Targeted Fix
      env:
        POSTGRES_CONNECTION_STRING: ${{ secrets.POSTGRES_CONNECTION_STRING }}
        NODE_ENV: production
      run: |
        cd github-actions-backend
        echo "🔧 Targeted Fix - Remaining Array Columns"
        echo "🎯 Goal: Fix 3 remaining columns in enhanced_analysis table"
        echo "📋 Columns: key_insights, market_signals, risk_assessment"
        echo ""
        echo "Based on investigation results:"
        echo "✅ baseline_analysis: ALL 5 columns already fixed"
        echo "🔴 enhanced_analysis: 3 columns still need fixing"
        echo ""
        
        # Run the targeted fix
        node fix-remaining-array-columns.js
        
        echo ""
        echo "🔍 Fix complete! Schema integrity should now be restored."

    - name: 🧪 Verify Fix Results
      env:
        POSTGRES_CONNECTION_STRING: ${{ secrets.POSTGRES_CONNECTION_STRING }}
        NODE_ENV: production
      run: |
        cd github-actions-backend
        echo "🔍 Verifying fix results..."
        echo ""
        
        # Check if schema integrity is now resolved
        if node schema-protector.js status; then
          echo "✅ Schema protection status check passed"
        else
          echo "⚠️  Schema protection status check had issues"
        fi
        
        echo ""
        echo "📋 Re-running investigation to verify fix..."
        if node investigate-schema-violation.js; then
          echo "✅ No more schema violations detected!"
        else
          echo "📋 Investigation complete (exit code indicates status)"
        fi

    - name: ✅ Success Summary  
      if: success()
      run: |
        echo ""
        echo "=" 
        echo "✅ TARGETED FIX COMPLETED SUCCESSFULLY"
        echo "="
        echo ""
        echo "🎯 Fixed remaining problematic columns:"
        echo "   - enhanced_analysis.key_insights: ARRAY → JSONB"
        echo "   - enhanced_analysis.market_signals: ARRAY → JSONB"  
        echo "   - enhanced_analysis.risk_assessment: text → JSONB"
        echo ""
        echo "📋 Schema Status:"
        echo "   - baseline_analysis: ALL 5 columns JSONB ✅"
        echo "   - enhanced_analysis: ALL columns JSONB ✅"
        echo "   - Schema integrity: RESTORED ✅"
        echo ""
        echo "🚀 Next Steps:"
        echo "   1. Test enhanced analysis pipeline"
        echo "   2. Verify malformed array literal errors are resolved"
        echo "   3. Run analyze-postgres-enhanced.yml workflow"

    - name: ❌ Failure Summary
      if: failure()
      run: |
        echo ""
        echo "❌ TARGETED FIX FAILED"
        echo ""
        echo "🔍 Check the logs above for specific error details"
        echo "📋 The remaining 3 columns may still need manual conversion"
        echo "⚠️  Schema integrity violation may still be present"
