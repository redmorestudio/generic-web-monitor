name: ğŸ”§ Fix Remaining Array Columns (Targeted)

on:
  workflow_dispatch:
    inputs: {}

jobs:
  fix-remaining-columns:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        cd github-actions-backend
        npm install

    - name: ğŸ”§ Execute Targeted Fix
      env:
        POSTGRES_CONNECTION_STRING: ${{ secrets.POSTGRES_CONNECTION_STRING }}
        NODE_ENV: production
      run: |
        cd github-actions-backend
        echo "ğŸ”§ Targeted Fix - Remaining Array Columns"
        echo "ğŸ¯ Goal: Fix 3 remaining columns in enhanced_analysis table"
        echo "ğŸ“‹ Columns: key_insights, market_signals, risk_assessment"
        echo ""
        echo "Based on investigation results:"
        echo "âœ… baseline_analysis: ALL 5 columns already fixed"
        echo "ğŸ”´ enhanced_analysis: 3 columns still need fixing"
        echo ""
        
        # Run the targeted fix
        node fix-remaining-array-columns.js
        
        echo ""
        echo "ğŸ” Fix complete! Schema integrity should now be restored."

    - name: ğŸ§ª Verify Fix Results
      env:
        POSTGRES_CONNECTION_STRING: ${{ secrets.POSTGRES_CONNECTION_STRING }}
        NODE_ENV: production
      run: |
        cd github-actions-backend
        echo "ğŸ” Verifying fix results..."
        echo ""
        
        # Check if schema integrity is now resolved
        if node schema-protector.js status; then
          echo "âœ… Schema protection status check passed"
        else
          echo "âš ï¸  Schema protection status check had issues"
        fi
        
        echo ""
        echo "ğŸ“‹ Re-running investigation to verify fix..."
        if node investigate-schema-violation.js; then
          echo "âœ… No more schema violations detected!"
        else
          echo "ğŸ“‹ Investigation complete (exit code indicates status)"
        fi

    - name: âœ… Success Summary  
      if: success()
      run: |
        echo ""
        echo "=" 
        echo "âœ… TARGETED FIX COMPLETED SUCCESSFULLY"
        echo "="
        echo ""
        echo "ğŸ¯ Fixed remaining problematic columns:"
        echo "   - enhanced_analysis.key_insights: ARRAY â†’ JSONB"
        echo "   - enhanced_analysis.market_signals: ARRAY â†’ JSONB"  
        echo "   - enhanced_analysis.risk_assessment: text â†’ JSONB"
        echo ""
        echo "ğŸ“‹ Schema Status:"
        echo "   - baseline_analysis: ALL 5 columns JSONB âœ…"
        echo "   - enhanced_analysis: ALL columns JSONB âœ…"
        echo "   - Schema integrity: RESTORED âœ…"
        echo ""
        echo "ğŸš€ Next Steps:"
        echo "   1. Test enhanced analysis pipeline"
        echo "   2. Verify malformed array literal errors are resolved"
        echo "   3. Run analyze-postgres-enhanced.yml workflow"

    - name: âŒ Failure Summary
      if: failure()
      run: |
        echo ""
        echo "âŒ TARGETED FIX FAILED"
        echo ""
        echo "ğŸ” Check the logs above for specific error details"
        echo "ğŸ“‹ The remaining 3 columns may still need manual conversion"
        echo "âš ï¸  Schema integrity violation may still be present"
