name: Manage Companies

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - add-company
          - add-url
          - delete-company
          - delete-url
          - enable-company
          - disable-company
          - list-companies
      company_name:
        description: 'Company name'
        required: false
        type: string
      company_category:
        description: 'Company category (for add-company)'
        required: false
        type: string
        default: 'AI Tools'
      url:
        description: 'URL to add/delete'
        required: false
        type: string
      url_type:
        description: 'URL type (homepage/blog/docs/api)'
        required: false
        type: string
        default: 'homepage'

jobs:
  manage-companies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd github-actions-backend
          npm install --omit=dev
      
      - name: Ensure database exists
        run: |
          cd github-actions-backend
          if [ ! -f data/intelligence.db ]; then
            echo "Database not found, initializing..."
            node scripts/init-db-three.js
          fi
          
          # Make the script executable
          chmod +x manage-companies.sh
      
      - name: Execute company management
        run: |
          cd github-actions-backend
          
          case "${{ inputs.action }}" in
            "list-companies")
              echo "📋 Listing all companies..."
              ./manage-companies.sh list
              ;;
              
            "add-company")
              echo "➕ Adding company: ${{ inputs.company_name }}"
              ./manage-companies.sh add-company "${{ inputs.company_name }}" "${{ inputs.company_category }}"
              
              # Also add the homepage URL if provided
              if [ -n "${{ inputs.url }}" ]; then
                echo "🔗 Adding homepage URL: ${{ inputs.url }}"
                ./manage-companies.sh add-url "${{ inputs.company_name }}" "${{ inputs.url }}" "homepage"
              fi
              ;;
              
            "add-url")
              echo "🔗 Adding URL to ${{ inputs.company_name }}"
              ./manage-companies.sh add-url "${{ inputs.company_name }}" "${{ inputs.url }}" "${{ inputs.url_type }}"
              ;;
              
            "delete-company")
              echo "❌ Deleting company: ${{ inputs.company_name }}"
              # Auto-confirm for workflow
              echo "y" | ./manage-companies.sh delete-company "${{ inputs.company_name }}"
              ;;
              
            "delete-url")
              echo "❌ Deleting URL: ${{ inputs.url }}"
              ./manage-companies.sh delete-url "${{ inputs.url }}"
              ;;
              
            "enable-company")
              echo "✅ Enabling company: ${{ inputs.company_name }}"
              ./manage-companies.sh enable "${{ inputs.company_name }}"
              ;;
              
            "disable-company")
              echo "⏸️ Disabling company: ${{ inputs.company_name }}"
              ./manage-companies.sh disable "${{ inputs.company_name }}"
              ;;
              
            *)
              echo "❌ Unknown action: ${{ inputs.action }}"
              exit 1
              ;;
          esac
          
          # Show current state
          echo -e "\n📊 Current companies:"
          ./manage-companies.sh list
      
      - name: Generate static data files
        run: |
          cd github-actions-backend
          echo "📊 Regenerating static JSON files..."
          node generate-static-data-three-db.js
          echo "✅ Static data files generated"
      
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Force add the intelligence database (it's gitignored)
          git add -f github-actions-backend/data/intelligence.db
          git add -f github-actions-backend/data/processed_content.db || true
          
          # Add the updated JSON files
          git add api-data/*.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "🏢 Company management: ${{ inputs.action }} ${{ inputs.company_name || inputs.url || '' }}"
            git push origin main
          fi
      
      # Deploy to GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
